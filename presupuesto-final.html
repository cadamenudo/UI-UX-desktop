<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Presupuesto – Cada Menudo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Nunito -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet"/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --cm-primary: #3956e8;
      --cm-secondary: #7459d9;
      --cm-bg: #f5f6ff;
      --cm-card-bg: #ffffff;
      --cm-text: #0f172a;
      --cm-muted: #64748b;
      --cm-border: #e5e7eb;
      --cm-success-bg: #ecfdf3;
      --cm-success-text: #15803d;
      --radius-card: 16px;
      --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.06);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Nunito", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--cm-bg);
      color: var(--cm-text);
    }

    .cm-page {
      padding: 24px 32px 32px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Header / título */
    .cm-page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 12px;
    }

    .cm-page-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .cm-breadcrumb {
      font-size: 0.8rem;
      color: var(--cm-muted);
    }

    .cm-page-title h1 {
      font-size: 1.6rem;
      font-weight: 800;
    }

    .cm-page-subtitle {
      font-size: 0.9rem;
      color: var(--cm-muted);
    }

    /* Tabs */
    .cm-tabs {
      display: inline-flex;
      border-radius: 999px;
      background: #e5e7ff;
      padding: 3px;
      gap: 4px;
      margin-bottom: 16px;
    }

    .cm-tab {
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      color: var(--cm-muted);
      font-weight: 600;
    }

    .cm-tab.active {
      background: #ffffff;
      color: var(--cm-primary);
      box-shadow: 0 2px 6px rgba(148, 163, 184, 0.4);
    }

    /* Controles header derecho */
    .cm-page-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .cm-segment {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: #eef2ff;
      gap: 4px;
    }

    .cm-segment button {
      border: none;
      background: transparent;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.85rem;
      color: var(--cm-muted);
      cursor: pointer;
    }

    .cm-segment button.active {
      background: #ffffff;
      color: var(--cm-primary);
      font-weight: 700;
      box-shadow: 0 2px 6px rgba(148, 163, 184, 0.4);
    }

    .cm-select-inline {
      border-radius: 999px;
      border: 1px solid var(--cm-border);
      background: #fff;
      padding: 6px 12px;
      font-size: 0.85rem;
      color: var(--cm-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      min-width: 130px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.04);
    }

    /* Cards base */
    .cm-card {
      background: var(--cm-card-bg);
      border-radius: var(--radius-card);
      padding: 16px 18px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 16px;
    }

    .cm-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .cm-card-header h2 {
      font-size: 1rem;
      font-weight: 700;
    }

    .cm-card-subtitle {
      font-size: 0.8rem;
      color: var(--cm-muted);
      margin-top: 2px;
    }

    /* Layout montos: main + side */
    .cm-layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.3fr);
      gap: 16px;
      margin-top: 12px;
    }

    .cm-layout-main {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .cm-layout-side {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Tarjetas por área */
    .cm-area-title {
      font-size: 0.95rem;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .cm-area-title span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .cm-pill {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: #eff6ff;
      color: var(--cm-primary);
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    th {
      font-weight: 700;
      color: var(--cm-muted);
      background: #f9fafb;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .cm-input-amount {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--cm-border);
      padding: 4px 8px;
      font-size: 0.8rem;
      text-align: right;
    }

    .cm-btn-sm {
      border-radius: 999px;
      border: none;
      background: #eef2ff;
      color: var(--cm-primary);
      font-size: 0.75rem;
      padding: 4px 10px;
      font-weight: 600;
      cursor: pointer;
    }

    .cm-btn-sm:hover {
      background: rgba(57, 86, 232, 0.09);
    }

    .cm-btn-link-sm {
      border: none;
      background: transparent;
      color: var(--cm-muted);
      font-size: 0.75rem;
      cursor: pointer;
    }

    /* Totales */
    .cm-totals-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    .cm-total-item {
      border-radius: 12px;
      border: 1px solid var(--cm-border);
      padding: 8px 10px;
      background: #f9fafb;
      text-align: right;
    }

    .cm-total-label {
      font-size: 0.75rem;
      color: var(--cm-muted);
    }

    .cm-total-value {
      font-size: 1rem;
      font-weight: 800;
    }

    .cm-donut-wrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: stretch;
    }

    .cm-donut-title {
      font-size: 0.9rem;
      font-weight: 700;
    }

    .cm-donut-legend {
      font-size: 0.75rem;
      color: var(--cm-muted);
    }

    .cm-donut-canvas {
      max-width: 260px;
      margin: 0 auto;
    }

    .cm-actions-row {
      display: flex;
      justify-content: flex-end;
      margin-top: 8px;
    }

    .cm-btn-primary {
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--cm-primary), var(--cm-secondary));
      color: #ffffff;
      font-size: 0.9rem;
      padding: 8px 18px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(55, 65, 81, 0.25);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .cm-btn-primary:hover {
      opacity: 0.96;
      transform: translateY(-1px);
    }

    /* Banner estado general (vs real) */
    .cm-banner {
      margin-top: 8px;
      margin-bottom: 20px;
      padding: 12px 16px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      box-shadow: var(--shadow-soft);
      background: var(--cm-success-bg);
      color: var(--cm-success-text);
      font-size: 0.9rem;
    }

    .cm-banner strong {
      font-weight: 800;
    }

    .cm-banner span.cm-banner-secondary {
      color: var(--cm-muted);
    }

    /* KPIs vs real */
    .cm-kpi-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .cm-kpi-card {
      background: var(--cm-card-bg);
      border-radius: var(--radius-card);
      padding: 14px 16px;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .cm-kpi-label {
      font-size: 0.8rem;
      color: var(--cm-muted);
    }

    .cm-kpi-value {
      font-size: 1.3rem;
      font-weight: 800;
    }

    .cm-kpi-sub {
      font-size: 0.8rem;
      color: var(--cm-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .cm-chip-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
    }

    .cm-chip-status.green {
      background: rgba(34, 197, 94, 0.08);
      color: #15803d;
    }

    .cm-chip-status.yellow {
      background: rgba(234, 179, 8, 0.1);
      color: #92400e;
    }

    .cm-chip-status.red {
      background: rgba(239, 68, 68, 0.1);
      color: #b91c1c;
    }

    /* Main row vs real */
    .cm-main-row {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.3fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .cm-filter-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      color: var(--cm-muted);
    }

    .cm-select-mini {
      border-radius: 999px;
      border: 1px solid var(--cm-border);
      background: #fff;
      padding: 4px 10px;
      font-size: 0.8rem;
      color: var(--cm-muted);
      cursor: pointer;
    }

    .cm-chart-container {
      position: relative;
      height: 260px;
    }

    /* Lista desvíos */
    .cm-category-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
      margin-bottom: 12px;
    }

    .cm-category-item {
      border-radius: 10px;
      border: 1px solid var(--cm-border);
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }

    .cm-category-top {
      display: flex;
      justify-content: space-between;
    }

    .cm-category-name {
      font-weight: 600;
    }

    .cm-category-amounts {
      color: var(--cm-muted);
    }

    .cm-badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
    }

    .cm-badge.green {
      background: rgba(34, 197, 94, 0.08);
      color: #15803d;
    }

    .cm-badge.yellow {
      background: rgba(234, 179, 8, 0.08);
      color: #92400e;
    }

    .cm-badge.red {
      background: rgba(239, 68, 68, 0.08);
      color: #b91c1c;
    }

    /* Tabla detalle */
    .cm-table-card {
      background: var(--cm-card-bg);
      border-radius: var(--radius-card);
      padding: 16px 18px 12px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 16px;
    }

    .cm-table-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .cm-table-wrapper {
      border-radius: 12px;
      border: 1px solid var(--cm-border);
      overflow: auto;
      max-height: 280px;
    }

    .cm-table-card-header h2 {
      font-size: 1rem;
      font-weight: 700;
    }

    .cm-table-actions {
      font-size: 0.8rem;
      color: var(--cm-primary);
      cursor: pointer;
    }

    /* Modal simple para añadir categorías */
    .cm-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .cm-modal-backdrop.open {
      display: flex;
    }

    .cm-modal {
      background: #ffffff;
      border-radius: 16px;
      padding: 18px 18px 16px;
      max-width: 420px;
      width: 92%;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.35);
    }

    .cm-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .cm-modal-header h2 {
      font-size: 1rem;
      font-weight: 700;
    }

    .cm-modal-close {
      border: none;
      background: transparent;
      font-size: 1.3rem;
      color: var(--cm-muted);
      cursor: pointer;
    }

    .cm-modal-body {
      font-size: 0.8rem;
      color: var(--cm-muted);
      margin-bottom: 10px;
    }

    .cm-modal-list {
      max-height: 220px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid var(--cm-border);
      padding: 8px;
      background: #f9fafb;
      margin-bottom: 10px;
    }

    .cm-modal-group {
      margin-bottom: 6px;
    }

    .cm-modal-group-title {
      font-weight: 700;
      font-size: 0.78rem;
      margin-bottom: 4px;
      color: #111827;
    }

    .cm-modal-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 4px;
      font-size: 0.78rem;
    }

    .cm-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .cm-btn-secondary {
      border-radius: 999px;
      border: 1px solid var(--cm-border);
      background: #ffffff;
      color: var(--cm-muted);
      font-size: 0.8rem;
      padding: 6px 12px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Tabs contenido */
    .cm-tab-content {
      display: none;
    }

    .cm-tab-content.active {
      display: block;
    }

    @media (max-width: 1024px) {
      .cm-layout,
      .cm-main-row {
        grid-template-columns: minmax(0, 1fr);
      }
      .cm-kpi-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 768px) {
      .cm-page {
        padding: 16px;
      }
      .cm-page-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .cm-page-controls {
        align-self: stretch;
      }
      .cm-totals-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <main class="cm-page">
    <!-- HEADER -->
    <header class="cm-page-header">
      <div class="cm-page-title">
        <span class="cm-breadcrumb">Tablero / Presupuesto</span>
        <h1>Presupuesto</h1>
        <p class="cm-page-subtitle" id="subtitlePeriodo">Mensual · Enero 2025</p>
      </div>

      <div>
        <div class="cm-tabs">
          <button class="cm-tab active" data-tab="montos">Presupuesto</button>
          <button class="cm-tab" data-tab="vsreal">Vs real</button>
        </div>
      </div>

      <div class="cm-page-controls">
        <div class="cm-segment" id="toggleTipo">
          <button type="button" data-tipo="mensual" class="active">Mensual</button>
          <button type="button" data-tipo="anual">Anual</button>
        </div>

        <div class="cm-select-inline" id="selectorPeriodo">
          <span id="labelPeriodo">Mes:</span>
          <strong id="valorPeriodo">Enero 2025</strong> ⌄
        </div>
      </div>
    </header>

    <!-- TAB 1: PRESUPUESTO (MONTOS) -->
    <section id="tab-montos" class="cm-tab-content active">
      <section class="cm-layout">
        <!-- Columna principal: 3 áreas -->
        <div class="cm-layout-main">

          <!-- INGRESOS -->
          <article class="cm-card">
            <div class="cm-area-title">
              <span>Ingresos <span class="cm-pill" id="badge-ingresos">3 categorías</span></span>
              <button class="cm-btn-sm" type="button" data-area="ingresos" onclick="openModal('ingresos')">+ Añadir</button>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Categoría</th>
                  <th style="width:120px; text-align:right;">Presupuesto</th>
                  <th style="width:40px;"></th>
                </tr>
              </thead>
              <tbody id="tbody-ingresos"></tbody>
            </table>
          </article>

          <!-- GASTOS -->
          <article class="cm-card">
            <div class="cm-area-title">
              <span>Gastos <span class="cm-pill" id="badge-gastos">5 categorías</span></span>
              <button class="cm-btn-sm" type="button" data-area="gastos" onclick="openModal('gastos')">+ Añadir</button>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Categoría</th>
                  <th style="width:120px; text-align:right;">Presupuesto</th>
                  <th style="width:40px;"></th>
                </tr>
              </thead>
              <tbody id="tbody-gastos"></tbody>
            </table>
          </article>

          <!-- AHORRO -->
          <article class="cm-card">
            <div class="cm-area-title">
              <span>Ahorro <span class="cm-pill" id="badge-ahorro">2 categorías</span></span>
              <button class="cm-btn-sm" type="button" data-area="ahorro" onclick="openModal('ahorro')">+ Añadir</button>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Categoría</th>
                  <th style="width:120px; text-align:right;">Presupuesto</th>
                  <th style="width:40px;"></th>
                </tr>
              </thead>
              <tbody id="tbody-ahorro"></tbody>
            </table>
          </article>
        </div>

        <!-- Columna lateral: Totales + dona -->
        <aside class="cm-layout-side">
          <!-- Totales -->
          <article class="cm-card">
            <div class="cm-card-header">
              <div>
                <h2>Totales del presupuesto</h2>
              </div>
            </div>
            <div class="cm-totals-grid">
              <div class="cm-total-item">
                <div class="cm-total-label">Ingresos</div>
                <div class="cm-total-value" id="total-ingresos">$0</div>
              </div>
              <div class="cm-total-item">
                <div class="cm-total-label">Gastos</div>
                <div class="cm-total-value" id="total-gastos">$0</div>
              </div>
              <div class="cm-total-item">
                <div class="cm-total-label">Ahorro</div>
                <div class="cm-total-value" id="total-ahorro">$0</div>
              </div>
            </div>
          </article>

          <!-- Dona gastos -->
          <article class="cm-card">
            <div class="cm-donut-wrapper">
              <div class="cm-donut-title">Distribución de gastos</div>
              <div class="cm-donut-legend" id="textoDonaGastos">
                Vista rápida de cómo se reparte tu gasto.
              </div>
              <div class="cm-donut-canvas">
                <canvas id="chartDonaGastos"></canvas>
              </div>
            </div>
          </article>

          <div class="cm-actions-row">
            <button class="cm-btn-primary" type="button" onclick="simularGuardarPresupuesto()">
              Guardar presupuesto
            </button>
          </div>
        </aside>
      </section>
    </section>

    <!-- TAB 2: VS REAL -->
    <section id="tab-vsreal" class="cm-tab-content">
      <!-- Banner -->
      <section class="cm-banner" id="bannerResumen">
        <div>
          <strong>SUPER:</strong> Estás usando el <strong id="textoPorcentajeUsado">0% de tu presupuesto de gastos.</strong>
        </div>
        <span class="cm-banner-secondary">
          Te quedan <strong id="textoRestante">$0</strong> para gastar sin salirte del plan.
        </span>
      </section>

      <!-- KPIs -->
      <section class="cm-kpi-row">
        <article class="cm-kpi-card">
          <span class="cm-kpi-label">Presupuesto de gastos</span>
          <div class="cm-kpi-value" id="kpiPresupuestoGastos">$0</div>
          <div class="cm-kpi-sub">Total que planeaste gastar.</div>
        </article>

        <article class="cm-kpi-card">
          <span class="cm-kpi-label">Gasto real</span>
          <div class="cm-kpi-value" id="kpiGastoReal">$0</div>
          <div class="cm-kpi-sub">Suma de tus gastos reales en este período.</div>
        </article>

        <article class="cm-kpi-card">
          <span class="cm-kpi-label">Diferencia</span>
          <div class="cm-kpi-value" id="kpiDiferencia">$0</div>
          <div class="cm-kpi-sub">
            <span id="badgeEstado" class="cm-chip-status green">Dentro del presupuesto</span>
          </div>
        </article>
      </section>

      <!-- Gráfico + desviaciones -->
      <section class="cm-main-row">
        <article class="cm-card">
          <div class="cm-card-header">
            <div>
              <h2>Presupuesto vs real por categoría</h2>
            </div>
            <div class="cm-filter-row">
              <span>Área:</span>
              <select class="cm-select-mini" id="selectAreaChart">
                <option value="gastos">Gastos</option>
                <option value="ingresos">Ingresos</option>
                <option value="ahorro">Ahorro</option>
              </select>
            </div>
          </div>
          <div class="cm-chart-container">
            <canvas id="chartVsReal"></canvas>
          </div>
        </article>

        <article class="cm-card">
          <div class="cm-card-header">
            <h2>Top desviaciones (gastos)</h2>
          </div>
          <div class="cm-category-list" id="listaDesvios"></div>
        </article>
      </section>

      <!-- Tabla detalle gastos -->
      <section class="cm-table-card">
        <header class="cm-table-card-header">
          <h2>Detalle de gastos</h2>
          <div class="cm-table-actions">Editar presupuesto en la pestaña anterior ⟶</div>
        </header>
        <div class="cm-table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Categoría</th>
                <th>Presupuesto</th>
                <th>Gasto real</th>
                <th>Diferencia</th>
                <th>% usado</th>
              </tr>
            </thead>
            <tbody id="tbody-gastos-detalle"></tbody>
          </table>
        </div>
      </section>
    </section>
  </main>

  <!-- MODAL AÑADIR CATEGORÍAS -->
  <div class="cm-modal-backdrop" id="modalCategorias">
    <div class="cm-modal">
      <div class="cm-modal-header">
        <h2 id="modalTitulo">Añadir categorías</h2>
        <button class="cm-modal-close" type="button" onclick="closeModal()">×</button>
      </div>
      <div class="cm-modal-body" id="modalDescripcion">
        Activa las categorías que quieras incluir en tu presupuesto.
      </div>
      <div class="cm-modal-list" id="modalLista"></div>
      <div class="cm-modal-footer">
        <button class="cm-btn-secondary" type="button" onclick="closeModal()">Cancelar</button>
        <button class="cm-btn-primary" type="button" onclick="applyModalSelection()">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // ==============================
    //  ESTADO GLOBAL Y DEMO DATA
    // ==============================
    const state = {
      tipoPeriodo: 'mensual', // 'mensual' | 'anual'
      periodoLabel: 'Enero 2025',
      areaModalActual: null,
      // Presupuesto por área
      presupuesto: {
        ingresos: [],
        gastos: [],
        ahorro: []
      },
      // Gasto/ingreso/ahorro real (para demo)
      real: {
        ingresos: [],
        gastos: [],
        ahorro: []
      }
    };

    // Catálogo simple para el modal
    const catalogo = {
      ingresos: {
        'Pago por trabajo': ['Salario', 'Bono', 'Comisión', 'Pago por hora'],
        'Otros ingresos': ['Negocio propio', 'Propina']
      },
      gastos: {
        'Vivienda': ['Hipoteca / Alquiler', 'Servicios básicos', 'Mantenimiento'],
        'Alimentación': ['Supermercado', 'Comidas fuera', 'Pedido a domicilio'],
        'Transporte': ['Gasolina', 'Mantenimiento', 'Transporte público / Uber'],
        'Otros': ['Entretenimiento', 'Regalos', 'Suscripciones']
      },
      ahorro: {
        'Emergencia': ['Fondo de emergencia'],
        'Metas': ['Ahorro meta', 'Viaje', 'Proyecto personal']
      }
    };

    function initDemoData() {
      // Ingresos demo
      state.presupuesto.ingresos = [
        { id: 'ing1', nombre: 'Salario', grupo: 'Pago por trabajo', monto: 2500 },
        { id: 'ing2', nombre: 'Bono', grupo: 'Pago por trabajo', monto: 300 },
        { id: 'ing3', nombre: 'Negocio propio', grupo: 'Otros ingresos', monto: 400 }
      ];
      state.real.ingresos = [
        { id: 'ing1', nombre: 'Salario', grupo: 'Pago por trabajo', monto: 2450 },
        { id: 'ing2', nombre: 'Bono', grupo: 'Pago por trabajo', monto: 320 },
        { id: 'ing3', nombre: 'Negocio propio', grupo: 'Otros ingresos', monto: 380 }
      ];

      // Gastos demo
      state.presupuesto.gastos = [
        { id: 'gas1', nombre: 'Vivienda', grupo: 'Vivienda', monto: 900 },
        { id: 'gas2', nombre: 'Alimentación', grupo: 'Alimentación', monto: 450 },
        { id: 'gas3', nombre: 'Transporte', grupo: 'Transporte', monto: 120 },
        { id: 'gas4', nombre: 'Servicios básicos', grupo: 'Vivienda', monto: 180 },
        { id: 'gas5', nombre: 'Entretenimiento', grupo: 'Otros', monto: 150 }
      ];
      state.real.gastos = [
        { id: 'gas1', nombre: 'Vivienda', grupo: 'Vivienda', monto: 890 },
        { id: 'gas2', nombre: 'Alimentación', grupo: 'Alimentación', monto: 510 },
        { id: 'gas3', nombre: 'Transporte', grupo: 'Transporte', monto: 95 },
        { id: 'gas4', nombre: 'Servicios básicos', grupo: 'Vivienda', monto: 175 },
        { id: 'gas5', nombre: 'Entretenimiento', grupo: 'Otros', monto: 80 }
      ];

      // Ahorro demo
      state.presupuesto.ahorro = [
        { id: 'aho1', nombre: 'Fondo de emergencia', grupo: 'Emergencia', monto: 200 },
        { id: 'aho2', nombre: 'Ahorro meta', grupo: 'Metas', monto: 150 }
      ];
      state.real.ahorro = [
        { id: 'aho1', nombre: 'Fondo de emergencia', grupo: 'Emergencia', monto: 200 },
        { id: 'aho2', nombre: 'Ahorro meta', grupo: 'Metas', monto: 100 }
      ];
    }

    // ==============================
    //  RENDER PRESUPUESTO (MONTOS)
    // ==============================
    function formatCurrency(value) {
      return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function renderBudgetTable(area) {
      const tbody = document.getElementById('tbody-' + area);
      tbody.innerHTML = '';
      const lista = state.presupuesto[area] || [];

      lista.forEach((item, index) => {
        const tr = document.createElement('tr');

        const tdNombre = document.createElement('td');
        tdNombre.textContent = item.nombre;
        tr.appendChild(tdNombre);

        const tdMonto = document.createElement('td');
        tdMonto.style.textAlign = 'right';
        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.step = '0.01';
        input.value = item.monto;
        input.className = 'cm-input-amount';
        input.addEventListener('input', () => {
          const val = parseFloat(input.value) || 0;
          state.presupuesto[area][index].monto = val;
          updateTotals();
          updateDonaGastos();
          updateVsRealFromState();
        });
        tdMonto.appendChild(input);
        tr.appendChild(tdMonto);

        const tdAcciones = document.createElement('td');
        tdAcciones.style.textAlign = 'right';
        const btnDel = document.createElement('button');
        btnDel.type = 'button';
        btnDel.className = 'cm-btn-link-sm';
        btnDel.textContent = '✕';
        btnDel.addEventListener('click', () => {
          state.presupuesto[area].splice(index, 1);
          // También borra el real asociado por id
          const idBorrar = item.id;
          state.real[area] = state.real[area].filter(r => r.id !== idBorrar);
          renderBudgetTable(area);
          updateBadges();
          updateTotals();
          updateDonaGastos();
          updateVsRealFromState();
        });
        tdAcciones.appendChild(btnDel);
        tr.appendChild(tdAcciones);

        tbody.appendChild(tr);
      });
    }

    function updateBadges() {
      ['ingresos','gastos','ahorro'].forEach(area => {
        const badge = document.getElementById('badge-' + area);
        if (!badge) return;
        const count = state.presupuesto[area].length;
        badge.textContent = count + (count === 1 ? ' categoría' : ' categorías');
      });
    }

    function updateTotals() {
      const factor = state.tipoPeriodo === 'anual' ? 12 : 1;

      const sumArea = (area) =>
        (state.presupuesto[area] || []).reduce((acc, item) => acc + (item.monto || 0), 0) * factor;

      const totalIng = sumArea('ingresos');
      const totalGas = sumArea('gastos');
      const totalAho = sumArea('ahorro');

      document.getElementById('total-ingresos').textContent = formatCurrency(totalIng);
      document.getElementById('total-gastos').textContent = formatCurrency(totalGas);
      document.getElementById('total-ahorro').textContent = formatCurrency(totalAho);
    }

    // ==============================
    //  DONA GASTOS (Chart.js)
    // ==============================
    let chartDona = null;

    function initDonaGastos() {
      const ctx = document.getElementById('chartDonaGastos');
      if (!ctx) return;
      chartDona = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: [
              '#3956e8',
              '#7459d9',
              '#e8c239',
              '#64748b',
              '#a5b4fc'
            ]
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'bottom',
              labels: { boxWidth: 10 }
            }
          },
          cutout: '60%'
        }
      });
      updateDonaGastos();
    }

    function updateDonaGastos() {
      if (!chartDona) return;
      const factor = state.tipoPeriodo === 'anual' ? 12 : 1;
      const gastos = state.presupuesto.gastos || [];

      chartDona.data.labels = gastos.map(g => g.nombre);
      chartDona.data.datasets[0].data = gastos.map(g => (g.monto || 0) * factor);
      chartDona.update();

      const total = gastos.reduce((acc, g) => acc + (g.monto || 0) * factor, 0);
      const texto = document.getElementById('textoDonaGastos');
      texto.textContent = total > 0
        ? 'Total de gastos: ' + formatCurrency(total)
        : 'Aún no has añadido categorías de gastos.';
    }

    // ==============================
    //  MODAL CATEGORÍAS
    // ==============================
    function openModal(area) {
      state.areaModalActual = area;
      const modal = document.getElementById('modalCategorias');
      const titulo = document.getElementById('modalTitulo');
      const desc = document.getElementById('modalDescripcion');
      const listaDiv = document.getElementById('modalLista');

      if (area === 'ingresos') titulo.textContent = 'Añadir categorías de ingresos';
      if (area === 'gastos') titulo.textContent = 'Añadir categorías de gastos';
      if (area === 'ahorro') titulo.textContent = 'Añadir categorías de ahorro';

      desc.textContent = 'Activa las categorías que quieras incluir.';

      // Construir lista
      const catArea = catalogo[area] || {};
      const actuales = new Set((state.presupuesto[area] || []).map(i => i.nombre));

      listaDiv.innerHTML = '';
      Object.entries(catArea).forEach(([grupo, items]) => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'cm-modal-group';

        const title = document.createElement('div');
        title.className = 'cm-modal-group-title';
        title.textContent = grupo;
        groupDiv.appendChild(title);

        items.forEach(nombre => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'cm-modal-item';

          const label = document.createElement('span');
          label.textContent = nombre;

          const check = document.createElement('input');
          check.type = 'checkbox';
          check.value = nombre;
          check.dataset.grupo = grupo;
          if (actuales.has(nombre)) check.checked = true;

          itemDiv.appendChild(label);
          itemDiv.appendChild(check);
          groupDiv.appendChild(itemDiv);
        });

        listaDiv.appendChild(groupDiv);
      });

      modal.classList.add('open');
    }

    function closeModal() {
      const modal = document.getElementById('modalCategorias');
      modal.classList.remove('open');
      state.areaModalActual = null;
    }

    function applyModalSelection() {
      const area = state.areaModalActual;
      if (!area) return;

      const listaDiv = document.getElementById('modalLista');
      const checks = listaDiv.querySelectorAll('input[type="checkbox"]');

      const seleccionadas = [];
      checks.forEach(ch => {
        if (ch.checked) {
          seleccionadas.push({
            nombre: ch.value,
            grupo: ch.dataset.grupo
          });
        }
      });

      // Actualizar presupuesto[area] manteniendo montos si ya existían
      const anteriores = state.presupuesto[area] || [];
      const mapaPrevios = new Map();
      anteriores.forEach(item => {
        mapaPrevios.set(item.nombre, item);
      });

      const nuevaLista = seleccionadas.map(sel => {
        const previo = mapaPrevios.get(sel.nombre);
        if (previo) {
          return previo; // mantiene id y monto
        }
        // nuevo
        return {
          id: area.slice(0,3) + '-' + sel.nombre.replace(/\s+/g,'_').toLowerCase(),
          nombre: sel.nombre,
          grupo: sel.grupo,
          monto: 0
        };
      });

      state.presupuesto[area] = nuevaLista;

      // Ajustar real[area]: mantener solo los que existan en presupuesto; si no existía, crear con mismo monto que presupuesto
      const mapaRealPrevio = new Map();
      (state.real[area] || []).forEach(r => {
        mapaRealPrevio.set(r.nombre, r);
      });
      state.real[area] = nuevaLista.map(item => {
        const prev = mapaRealPrevio.get(item.nombre);
        if (prev) return prev;
        return {
          id: item.id,
          nombre: item.nombre,
          grupo: item.grupo,
          monto: item.monto
        };
      });

      renderBudgetTable(area);
      updateBadges();
      updateTotals();
      updateDonaGastos();
      updateVsRealFromState();

      closeModal();
    }

    // ==============================
    //  TAB VS REAL – CÁLCULOS
    // ==============================
    let chartVsReal = null;

    function getFactor() {
      return state.tipoPeriodo === 'anual' ? 12 : 1;
    }

    function computeSumArea(area, tipo) {
      const factor = getFactor();
      const lista = state[tipo][area] || [];
      return lista.reduce((acc, item) => acc + (item.monto || 0) * factor, 0);
    }

    function updateBannerAndKPIs() {
      const presupuestoGastos = computeSumArea('gastos', 'presupuesto');
      const realGastos = computeSumArea('gastos', 'real');
      const diff = presupuestoGastos - realGastos;
      const porc = presupuestoGastos > 0 ? (realGastos / presupuestoGastos) * 100 : 0;

      const kPres = document.getElementById('kpiPresupuestoGastos');
      const kReal = document.getElementById('kpiGastoReal');
      const kDiff = document.getElementById('kpiDiferencia');
      const textoPorc = document.getElementById('textoPorcentajeUsado');
      const textoRestante = document.getElementById('textoRestante');
      const badgeEstado = document.getElementById('badgeEstado');

      kPres.textContent = formatCurrency(presupuestoGastos);
      kReal.textContent = formatCurrency(realGastos);
      kDiff.textContent = formatCurrency(diff);

      textoPorc.textContent = Math.round(porc) + '% de tu presupuesto de gastos.';
      textoRestante.textContent = diff >= 0 ? formatCurrency(diff) : formatCurrency(-diff);

      // Estado
      badgeEstado.classList.remove('green','yellow','red');
      if (porc <= 90) {
        badgeEstado.classList.add('green');
        badgeEstado.textContent = 'Dentro del presupuesto';
      } else if (porc <= 110) {
        badgeEstado.classList.add('yellow');
        badgeEstado.textContent = 'Cerca del límite';
      } else {
        badgeEstado.classList.add('red');
        badgeEstado.textContent = 'Sobre el presupuesto';
      }
    }

    function buildChartData(area) {
      const factor = getFactor();
      const pres = state.presupuesto[area] || [];
      const real = state.real[area] || [];

      const mapaReal = new Map();
      real.forEach(r => mapaReal.set(r.nombre, r));

      const labels = [];
      const dataPres = [];
      const dataReal = [];

      pres.forEach(p => {
        labels.push(p.nombre);
        dataPres.push((p.monto || 0) * factor);
        const r = mapaReal.get(p.nombre);
        dataReal.push(r ? (r.monto || 0) * factor : 0);
      });

      return { labels, dataPres, dataReal };
    }

    function initVsRealChart() {
      const ctx = document.getElementById('chartVsReal');
      if (!ctx) return;

      const { labels, dataPres, dataReal } = buildChartData('gastos');

      chartVsReal = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Presupuesto',
              data: dataPres,
              backgroundColor: '#3956e8'
            },
            {
              label: 'Real',
              data: dataReal,
              backgroundColor: '#e8c239'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { boxWidth: 12 }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.parsed.y || 0;
                  return ctx.dataset.label + ': ' + formatCurrency(v);
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { font: { size: 10 } }
            },
            y: {
              beginAtZero: true,
              ticks: {
                callback: value => '$' + value
              }
            }
          }
        }
      });
    }

    function updateVsRealChart() {
      if (!chartVsReal) return;
      const area = document.getElementById('selectAreaChart').value || 'gastos';
      const { labels, dataPres, dataReal } = buildChartData(area);
      chartVsReal.data.labels = labels;
      chartVsReal.data.datasets[0].data = dataPres;
      chartVsReal.data.datasets[1].data = dataReal;
      chartVsReal.update();
    }

    function renderListaDesvios() {
      const cont = document.getElementById('listaDesvios');
      cont.innerHTML = '';

      const factor = getFactor();
      const pres = state.presupuesto.gastos || [];
      const real = state.real.gastos || [];
      const mapaReal = new Map();
      real.forEach(r => mapaReal.set(r.nombre, r));

      const items = pres.map(p => {
        const r = mapaReal.get(p.nombre);
        const preMonto = (p.monto || 0) * factor;
        const realMonto = r ? (r.monto || 0) * factor : 0;
        const diff = realMonto - preMonto;
        const porc = preMonto > 0 ? (realMonto / preMonto) * 100 : 0;
        return { nombre: p.nombre, presupuesto: preMonto, real: realMonto, diff, porc };
      });

      items.sort((a, b) => b.porc - a.porc);
      const top = items.slice(0, 3);

      top.forEach(item => {
        const div = document.createElement('div');
        div.className = 'cm-category-item';

        const topRow = document.createElement('div');
        topRow.className = 'cm-category-top';

        const nameSpan = document.createElement('span');
        nameSpan.className = 'cm-category-name';
        nameSpan.textContent = item.nombre;

        const amountsSpan = document.createElement('span');
        amountsSpan.className = 'cm-category-amounts';
        amountsSpan.textContent = formatCurrency(item.presupuesto) + ' / ' + formatCurrency(item.real);

        topRow.appendChild(nameSpan);
        topRow.appendChild(amountsSpan);
        div.appendChild(topRow);

        const badgeRow = document.createElement('div');
        badgeRow.className = 'cm-category-top';
        badgeRow.style.marginTop = '4px';

        const badge = document.createElement('span');
        let cls = 'green';
        if (item.porc > 110) cls = 'red';
        else if (item.porc > 95) cls = 'yellow';
        badge.className = 'cm-badge ' + cls;
        badge.textContent = Math.round(item.porc) + '% del presupuesto';
        badgeRow.appendChild(badge);

        div.appendChild(badgeRow);
        cont.appendChild(div);
      });
    }

    function renderTablaDetalleGastos() {
      const tbody = document.getElementById('tbody-gastos-detalle');
      tbody.innerHTML = '';
      const factor = getFactor();

      const pres = state.presupuesto.gastos || [];
      const real = state.real.gastos || [];
      const mapaReal = new Map();
      real.forEach(r => mapaReal.set(r.nombre, r));

      pres.forEach(p => {
        const tr = document.createElement('tr');
        const preMonto = (p.monto || 0) * factor;
        const r = mapaReal.get(p.nombre);
        const realMonto = r ? (r.monto || 0) * factor : 0;
        const diff = realMonto - preMonto;
        const porc = preMonto > 0 ? (realMonto / preMonto) * 100 : 0;

        const tdCat = document.createElement('td');
        tdCat.textContent = p.nombre;
        tr.appendChild(tdCat);

        const tdPre = document.createElement('td');
        tdPre.textContent = formatCurrency(preMonto);
        tr.appendChild(tdPre);

        const tdReal = document.createElement('td');
        tdReal.textContent = formatCurrency(realMonto);
        tr.appendChild(tdReal);

        const tdDiff = document.createElement('td');
        tdDiff.textContent = (diff >= 0 ? '+' : '') + formatCurrency(diff);
        tr.appendChild(tdDiff);

        const tdPorc = document.createElement('td');
        tdPorc.textContent = Math.round(porc) + '%';
        tr.appendChild(tdPorc);

        tbody.appendChild(tr);
      });
    }

    function updateVsRealFromState() {
      updateBannerAndKPIs();
      updateVsRealChart();
      renderListaDesvios();
      renderTablaDetalleGastos();
    }

    // ==============================
    //  TABS + TOGGLE TIPO PERIODO
    // ==============================
    function initTabs() {
      const tabs = document.querySelectorAll('.cm-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          const target = tab.dataset.tab;
          document.querySelectorAll('.cm-tab-content').forEach(sec => {
            sec.classList.remove('active');
          });
          document.getElementById('tab-' + target).classList.add('active');
        });
      });
    }

    function initTipoPeriodoToggle() {
      const btns = document.querySelectorAll('#toggleTipo button');
      btns.forEach(btn => {
        btn.addEventListener('click', () => {
          btns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.tipoPeriodo = btn.dataset.tipo;
          document.getElementById('subtitlePeriodo').textContent =
            (state.tipoPeriodo === 'mensual' ? 'Mensual · ' : 'Anual · ') + state.periodoLabel;

          // Cambia label "Mes:" / "Año:"
          const lbl = document.getElementById('labelPeriodo');
          lbl.textContent = state.tipoPeriodo === 'mensual' ? 'Mes:' : 'Año:';

          updateTotals();
          updateDonaGastos();
          updateVsRealFromState();
        });
      });
    }

    function simularGuardarPresupuesto() {
      alert('Presupuesto guardado (demo).');
    }

    // ==============================
    //  INIT
    // ==============================
    window.addEventListener('DOMContentLoaded', () => {
      initDemoData();
      initTabs();
      initTipoPeriodoToggle();

      // Render tablas montos
      renderBudgetTable('ingresos');
      renderBudgetTable('gastos');
      renderBudgetTable('ahorro');
      updateBadges();
      updateTotals();

      // Dona
      initDonaGastos();

      // Vs real
      initVsRealChart();
      document.getElementById('selectAreaChart').addEventListener('change', updateVsRealChart);
      updateVsRealFromState();
    });
  </script>
</body>
</html>
