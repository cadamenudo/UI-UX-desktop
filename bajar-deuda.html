<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cada Menudo – Bajar Deuda (Desktop)</title>

  <!-- Greycliff CF (tu link) -->
  <link rel="stylesheet" href="https://cadamenudo.github.io/UI-UX/css-fonts.css"/>

  <style>
    :root{
      --primary:#3956E8;
      --secondary:#7459D9;
      --accent:#E8C239;
      --bg:#F6F7FF;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748B;
      --stroke:#e6eaf5;
      --soft:#EEF3FF;

      --placeholder:#94a3b8;

      --radius:18px;
      --radius2:24px;
      --shadow:0 14px 40px rgba(15,23,42,.10);
    }

    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{
      margin:0;
      font-family: "Greycliff CF", "Nunito", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 480px at 18% 6%, rgba(116,89,217,.14), transparent 55%),
        radial-gradient(900px 520px at 84% 18%, rgba(57,86,232,.16), transparent 55%),
        var(--bg);
    }

    /* MAIN WRAP (sin sidebar) */
    .main{
      padding:18px 18px 24px;
      max-width: 1320px;
      margin: 0 auto;
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:14px;
    }
    .title{
      display:flex; flex-direction:column; gap:4px;
    }
    .title h2{ margin:0; font-size:20px; letter-spacing:.2px;}
    .title small{ color:var(--muted); font-weight:650; }

    .topActions{
      display:flex; gap:10px; align-items:center;
    }
    .search{
      width:360px; max-width:42vw;
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 10px 22px rgba(15,23,42,.06);
    }
    .search input{
      border:0; outline:0; width:100%;
      font-size:13px;
      font-weight:650;
      color:var(--ink);
    }
    .btn{
      border:0; cursor:pointer;
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .btnPrimary{
      background:linear-gradient(135deg, var(--primary), var(--secondary));
      color:#fff;
      box-shadow:0 14px 24px rgba(57,86,232,.22);
    }
    .btnGhost{
      background:#fff;
      border:1px solid var(--stroke);
      color:var(--ink);
      box-shadow:0 10px 20px rgba(15,23,42,.06);
    }

    /* ✅ Placeholder gris suave */
    input::placeholder{ color: var(--placeholder); font-weight:650; }
    textarea::placeholder{ color: var(--placeholder); font-weight:650; }
    .search input::placeholder{ color: var(--placeholder); font-weight:650; }

    /* GRID */
    .grid{
      display:grid;
      grid-template-columns: 440px 1fr;
      gap:14px;
      align-items:start;
    }

    .card{
      background:rgba(255,255,255,.85);
      border:1px solid var(--stroke);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHd{
      padding:14px 16px 10px;
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:linear-gradient(180deg, rgba(57,86,232,.06), rgba(116,89,217,.04));
    }
    .cardHd h3{ margin:0; font-size:14px; letter-spacing:.2px;}
    .cardHd .meta{ color:var(--muted); font-size:12px; font-weight:700;}
    .cardBd{ padding:14px 16px 16px; }

    /* FILTERS */
    .filters{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-bottom:12px;
    }
    .field label{
      display:block;
      font-size:11px;
      color:var(--muted);
      font-weight:900;
      margin-bottom:6px;
      letter-spacing:.4px;
      text-transform:uppercase;
    }
    .field select, .field input{
      width:100%;
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      font-weight:700;
      outline:none;
      color:var(--ink);
    }

    /* LISTA */
    .debtList{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:72vh;
      overflow:auto;
      padding-right:2px;
    }

    .debtItem{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:12px 12px;
      border-radius:18px;
      border:1px solid var(--stroke);
      background:#fff;
      cursor:pointer;
      transition:transform .08s ease, border-color .08s ease, background .08s ease;
    }
    .debtItem:hover{ transform: translateY(-1px); border-color: rgba(57,86,232,.25); }
    .debtItem.active{
      background:linear-gradient(180deg, rgba(57,86,232,.10), rgba(116,89,217,.06));
      border-color: rgba(57,86,232,.28);
    }
    .debtName{ font-weight:950; font-size:13px; }
    .debtSub{ color:var(--muted); font-size:12px; font-weight:750; margin-top:2px; }

    .amountCol{
      text-align:right;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-width:120px;
    }
    .amt{ font-weight:1000; font-size:13px; }
    .mini{ color:var(--muted); font-size:11px; font-weight:800; }

    /* DETALLE */
    .hero{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .hero .left h4{ margin:0; font-size:16px; font-weight:1000; }
    .hero .left p{ margin:4px 0 0; color:var(--muted); font-weight:750; font-size:12px; }

    .hero .right{
      display:flex; gap:10px; align-items:center;
      flex-wrap:wrap; justify-content:flex-end;
    }

    .progressWrap{
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:18px;
      padding:12px;
      margin-bottom:12px;
    }
    .progTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .bigPct{
      font-size:22px;
      font-weight:1100;
      letter-spacing:.2px;
    }
    .bar{
      width:100%;
      height:12px;
      border-radius:999px;
      background:rgba(100,116,139,.14);
      overflow:hidden;
      border:1px solid rgba(100,116,139,.18);
    }
    .bar > div{
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg, var(--primary), var(--secondary));
      transition:width .35s ease;
    }

    .metrics{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:12px;
    }
    .metric{
      border:1px solid var(--stroke);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(57,86,232,.06), rgba(255,255,255,.85));
      padding:10px 10px;
    }
    .metric small{
      display:block;
      font-size:11px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.4px;
      text-transform:uppercase;
      margin-bottom:6px;
    }
    .metric b{ font-size:14px; font-weight:1100; }

    .box{
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:18px;
      padding:12px;
      margin-top:12px;
    }
    .box h5{
      margin:0 0 10px;
      font-size:12px;
      letter-spacing:.35px;
      text-transform:uppercase;
      color:var(--muted);
      font-weight:1000;
    }

    .history{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:360px;
      overflow:auto;
      padding-right:2px;
    }
    .txn{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px 10px;
      background:rgba(255,255,255,.9);
    }
    .txn .l b{ display:block; font-size:12px; font-weight:1000; }
    .txn .l small{ color:var(--muted); font-weight:800; font-size:11px; }
    .txn .r{ text-align:right; }
    .txn .r b{ font-weight:1100; font-size:12px; }
    .txn .r small{ display:block; font-size:11px; color:var(--muted); font-weight:800; margin-top:2px; }

    /* MODAL */
    .overlay{
      position:fixed; inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(560px, 96vw);
      border-radius:24px;
      background:#fff;
      border:1px solid rgba(255,255,255,.25);
      box-shadow:0 30px 80px rgba(0,0,0,.30);
      overflow:hidden;
    }
    .modalHd{
      padding:14px 16px;
      background:linear-gradient(135deg, rgba(57,86,232,.12), rgba(116,89,217,.10));
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalHd b{ font-size:14px; font-weight:1100; }
    .xBtn{
      border:1px solid var(--stroke);
      background:#fff;
      width:36px; height:36px;
      border-radius:12px;
      cursor:pointer;
      font-weight:1100;
    }
    .modalBd{ padding:14px 16px 16px; }
    .modalGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .modalFoot{
      padding:12px 16px 16px;
      display:flex; justify-content:flex-end; gap:10px;
    }

    .muted{ color:var(--muted); font-weight:800; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:11px; }

    @media (max-width: 1080px){
      .grid{ grid-template-columns: 1fr; }
      .search{ width:100%; max-width:none; }
      .metrics{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <main class="main">
    <div class="topbar">
      <div class="title">
        <h2>Bajar deuda</h2>
        <small>Progreso transparente: monto original, total abonado, saldo real y % pagado.</small>
      </div>

      <div class="topActions">
        <div class="search" role="search">
          <span class="muted">⌕</span>
          <input id="q" type="text" placeholder="Buscar deuda (ej. Visa, Auto, Universidad)…" />
          <span class="muted kbd">⌘K</span>
        </div>
        <button class="btn btnPrimary" id="btnNewDebt" type="button">+ Nueva deuda</button>
      </div>
    </div>

    <section class="grid">
      <!-- Lista -->
      <div class="card">
        <div class="cardHd">
          <h3>Deudas</h3>
          <div class="meta"><span id="countDebts">0</span> activas</div>
        </div>

        <div class="cardBd">
          <div class="filters">
            <div class="field">
              <label for="filterCategory">Categoría</label>
              <select id="filterCategory"></select>
            </div>
          </div>

          <div class="debtList" id="debtList" aria-label="Lista de deudas"></div>
        </div>
      </div>

      <!-- Detalle -->
      <div class="card">
        <div class="cardHd">
          <h3>Progreso real</h3>
          <div class="meta">Historial intacto</div>
        </div>

        <div class="cardBd">
          <div class="hero">
            <div class="left">
              <h4 id="dTitle">Selecciona una deuda</h4>
              <p id="dSubtitle">Verás monto original, abonado, saldo real y % pagado.</p>
            </div>
            <div class="right">
              <button class="btn btnGhost" id="btnAddPayment" type="button" disabled>+ Abono</button>
              <button class="btn btnGhost" id="btnEditDebt" type="button" disabled>Editar</button>
            </div>
          </div>

          <div class="progressWrap">
            <div class="progTop">
              <div>
                <div class="muted" style="font-weight:950;font-size:12px">Porcentaje pagado</div>
                <div class="bigPct" id="dPct">—</div>
              </div>
              <div style="text-align:right">
                <div class="muted" style="font-weight:950;font-size:12px">Saldo actual real</div>
                <div style="font-size:18px;font-weight:1100" id="dBalance">—</div>
              </div>
            </div>
            <div class="bar" aria-label="Barra de progreso"><div id="barFill"></div></div>

            <div class="metrics">
              <div class="metric">
                <small>Monto original</small>
                <b id="dOriginal">—</b>
              </div>
              <div class="metric">
                <small>Total abonado</small>
                <b id="dPaid">—</b>
              </div>
              <div class="metric">
                <small>% pagado</small>
                <b id="dPctSmall">—</b>
              </div>
              <div class="metric">
                <small>Categoría</small>
                <b id="dCat">—</b>
              </div>
            </div>
          </div>

          <div class="box">
            <h5>Historial de abonos</h5>
            <div class="history" id="history"></div>
          </div>

        </div>
      </div>
    </section>
  </main>

  <!-- Modal: Abono -->
  <div class="overlay" id="overlayPay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="payTitle">
      <div class="modalHd">
        <b id="payTitle">Registrar abono</b>
        <button class="xBtn" id="closePay" type="button" aria-label="Cerrar">✕</button>
      </div>
      <div class="modalBd">
        <div class="modalGrid">
          <div class="field">
            <label for="payDate">Fecha</label>
            <input id="payDate" type="date"/>
          </div>
          <div class="field">
            <label for="payAmount">Monto abonado</label>
            <input id="payAmount" type="number" min="0" step="0.01" placeholder="Ej. 125.00"/>
          </div>
          <div class="field" style="grid-column:1 / -1;">
            <label for="payNote">Nota (opcional)</label>
            <input id="payNote" type="text" placeholder="Ej. Pago mínimo, pago extra…"/>
          </div>
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn btnGhost" id="cancelPay" type="button">Cancelar</button>
        <button class="btn btnPrimary" id="savePay" type="button">Guardar abono</button>
      </div>
    </div>
  </div>

  <!-- Modal: Nueva deuda -->
  <div class="overlay" id="overlayDebt" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="debtTitle">
      <div class="modalHd">
        <b id="debtTitle">Nueva deuda</b>
        <button class="xBtn" id="closeDebt" type="button" aria-label="Cerrar">✕</button>
      </div>
      <div class="modalBd">
        <div class="modalGrid">
          <div class="field">
            <label for="newName">Nombre</label>
            <input id="newName" type="text" placeholder="Ej. Visa, Auto, Préstamo…"/>
          </div>
          <div class="field">
            <label for="newCategory">Categoría</label>
            <select id="newCategory"></select>
          </div>
          <div class="field">
            <label for="newOriginal">Monto original</label>
            <input id="newOriginal" type="number" min="0" step="0.01" placeholder="Ej. 5000"/>
          </div>
          <div class="field">
            <label for="newApr">APR / interés (opcional)</label>
            <input id="newApr" type="number" min="0" step="0.01" placeholder="Ej. 24.99"/>
          </div>
        </div>
        <p class="muted" style="margin:10px 0 0;font-size:12px;line-height:1.35">
          Progreso = <b>monto original</b> − <b>total abonado</b>.
        </p>
      </div>
      <div class="modalFoot">
        <button class="btn btnGhost" id="cancelDebt" type="button">Cancelar</button>
        <button class="btn btnPrimary" id="saveDebt" type="button">Crear deuda</button>
      </div>
    </div>
  </div>

  <script>
    // ✅ Categorías base (completa tu lista aquí)
    const BASE_CATEGORIES = [
      {id:'all', name:'Todas'},
      {id:'tarjetas',name:'Tarjetas de Crédito, tiendas, gasolinera, etc.'},
      {id:'linea_personal',name:'Línea crédito personal'},
      {id:'linea_propiedad',name:'Línea crédito de la propiedad'},
      {id:'casa',name:'Casa'},
      {id:'otras_propiedades',name:'Otras propiedad (barco, casa de playa, etc.)'},
      {id:'auto',name:'Auto'},
      {id:'educacion',name:'Educación'},
      {id:'muebles',name:'Préstamos para Muebles y Enseres'},
      {id:'mejoras',name:'Mejoras al hogar'},
      {id:'seguro_vida',name:'Préstamo de seguro de vida'},
      {id:'margen_broker',name:'Préstamos al Margen con casa de corretaje'},
      // agrega el resto…
    ];

    // Demo data
    let debts = [
      {
        id: cryptoId(),
        name: 'Visa – Banco',
        categoryId: 'tarjetas',
        original: 8200,
        apr: 24.99,
        payments: [
          {date:'2026-01-10', amount:250, note:'Pago mínimo'},
          {date:'2026-02-05', amount:400, note:'Pago extra'}
        ]
      },
      {
        id: cryptoId(),
        name: 'Préstamo Auto',
        categoryId: 'auto',
        original: 14500,
        apr: 7.50,
        payments: [
          {date:'2026-01-15', amount:375, note:'Pago mensual'},
          {date:'2026-02-15', amount:375, note:'Pago mensual'}
        ]
      },
      {
        id: cryptoId(),
        name: 'Universidad',
        categoryId: 'educacion',
        original: 5200,
        apr: 0,
        payments: [
          {date:'2026-02-01', amount:200, note:'Abono'}
        ]
      }
    ];

    let selectedDebtId = null;

    // Elements
    const debtListEl = document.getElementById('debtList');
    const countDebtsEl = document.getElementById('countDebts');

    const filterCategoryEl = document.getElementById('filterCategory');
    const qEl = document.getElementById('q');

    const dTitle = document.getElementById('dTitle');
    const dSubtitle = document.getElementById('dSubtitle');

    const dPct = document.getElementById('dPct');
    const dPctSmall = document.getElementById('dPctSmall');
    const dBalance = document.getElementById('dBalance');
    const dOriginal = document.getElementById('dOriginal');
    const dPaid = document.getElementById('dPaid');
    const dCat = document.getElementById('dCat');
    const barFill = document.getElementById('barFill');

    const historyEl = document.getElementById('history');
    const btnAddPayment = document.getElementById('btnAddPayment');
    const btnEditDebt = document.getElementById('btnEditDebt');

    // Modals
    const overlayPay = document.getElementById('overlayPay');
    const overlayDebt = document.getElementById('overlayDebt');

    const btnNewDebt = document.getElementById('btnNewDebt');

    const closePay = document.getElementById('closePay');
    const cancelPay = document.getElementById('cancelPay');
    const savePay = document.getElementById('savePay');
    const payDate = document.getElementById('payDate');
    const payAmount = document.getElementById('payAmount');
    const payNote = document.getElementById('payNote');

    const closeDebt = document.getElementById('closeDebt');
    const cancelDebt = document.getElementById('cancelDebt');
    const saveDebt = document.getElementById('saveDebt');
    const newName = document.getElementById('newName');
    const newCategory = document.getElementById('newCategory');
    const newOriginal = document.getElementById('newOriginal');
    const newApr = document.getElementById('newApr');

    // Init
    hydrateCategorySelect(filterCategoryEl, true);
    hydrateCategorySelect(newCategory, false);

    // default dates
    payDate.value = isoToday();

    render();

    // Events
    filterCategoryEl.addEventListener('change', render);
    qEl.addEventListener('input', debounce(render, 120));

    btnNewDebt.addEventListener('click', () => {
      openModal(overlayDebt);
      newName.value = '';
      newOriginal.value = '';
      newApr.value = '';
      newCategory.value = BASE_CATEGORIES.find(c => c.id !== 'all')?.id || 'tarjetas';
      setTimeout(() => newName.focus(), 0);
    });

    btnAddPayment.addEventListener('click', () => {
      if(!selectedDebtId) return;
      openModal(overlayPay);
      payDate.value = isoToday();
      payAmount.value = '';
      payNote.value = '';
      setTimeout(() => payAmount.focus(), 0);
    });

    closePay.addEventListener('click', () => closeModal(overlayPay));
    cancelPay.addEventListener('click', () => closeModal(overlayPay));
    closeDebt.addEventListener('click', () => closeModal(overlayDebt));
    cancelDebt.addEventListener('click', () => closeModal(overlayDebt));

    savePay.addEventListener('click', () => {
      const d = getSelectedDebt();
      if(!d) return;

      const amt = Number(payAmount.value || 0);
      const dt = payDate.value || isoToday();
      const note = (payNote.value || '').trim();

      if(amt <= 0){
        shake(payAmount);
        payAmount.focus();
        return;
      }

      d.payments.push({date: dt, amount: amt, note});
      d.payments.sort((a,b) => (a.date < b.date ? 1 : -1));
      closeModal(overlayPay);
      renderDetail(d);
      renderList();
    });

    saveDebt.addEventListener('click', () => {
      const name = (newName.value || '').trim();
      const cat = newCategory.value;
      const orig = Number(newOriginal.value || 0);
      const apr = Number(newApr.value || 0);

      if(!name){ shake(newName); newName.focus(); return; }
      if(orig <= 0){ shake(newOriginal); newOriginal.focus(); return; }

      debts.unshift({
        id: cryptoId(),
        name,
        categoryId: cat,
        original: orig,
        apr,
        payments: []
      });

      closeModal(overlayDebt);
      render();
      selectedDebtId = debts[0].id;
      renderDetail(getSelectedDebt());
      renderList();
    });

    // Keyboard shortcut ⌘K or Ctrl+K focus search
    document.addEventListener('keydown', (e) => {
      const k = e.key.toLowerCase();
      if((e.metaKey || e.ctrlKey) && k === 'k'){
        e.preventDefault();
        qEl.focus();
      }
      if(k === 'escape'){
        closeModal(overlayPay);
        closeModal(overlayDebt);
      }
    });

    overlayPay.addEventListener('click', (e) => { if(e.target === overlayPay) closeModal(overlayPay); });
    overlayDebt.addEventListener('click', (e) => { if(e.target === overlayDebt) closeModal(overlayDebt); });

    // Render
    function render(){
      renderList();
      countDebtsEl.textContent = debts.length;

      const selected = getSelectedDebt();
      if(selected){
        renderDetail(selected);
      }else{
        renderEmptyDetail();
      }
    }

    function renderList(){
      const filtered = applyFilters(debts);

      debtListEl.innerHTML = '';
      if(filtered.length === 0){
        debtListEl.innerHTML = `
          <div style="padding:12px;border:1px dashed var(--stroke);border-radius:18px;background:rgba(255,255,255,.85)">
            <b style="display:block;font-size:13px">No hay deudas que coincidan</b>
            <div class="muted" style="margin-top:6px;font-size:12px">Ajusta filtros o crea una nueva deuda.</div>
          </div>`;
        return;
      }

      filtered.forEach(d => {
        const stats = compute(d);
        const catName = getCatName(d.categoryId);
        const active = (d.id === selectedDebtId);

        const el = document.createElement('div');
        el.className = 'debtItem' + (active ? ' active' : '');
        el.innerHTML = `
          <div>
            <div class="debtName">${escapeHtml(d.name)}</div>
            <div class="debtSub">${escapeHtml(catName)} · ${d.apr ? (d.apr.toFixed(2)+'% APR') : 'sin APR'}</div>
          </div>
          <div class="amountCol">
            <div>
              <div class="amt">${money(stats.balance)}</div>
              <div class="mini">saldo real</div>
            </div>
            <div>
              <div class="mini">${stats.pct.toFixed(0)}% pagado</div>
            </div>
          </div>
        `;
        el.addEventListener('click', () => {
          selectedDebtId = d.id;
          renderList();
          renderDetail(d);
        });
        debtListEl.appendChild(el);
      });

      if(!selectedDebtId && filtered[0]){
        selectedDebtId = filtered[0].id;
        renderList();
        renderDetail(getSelectedDebt());
      }
    }

    function renderDetail(d){
      if(!d){ renderEmptyDetail(); return; }

      btnAddPayment.disabled = false;
      btnEditDebt.disabled = false;

      const stats = compute(d);
      const catName = getCatName(d.categoryId);

      dTitle.textContent = d.name;
      dSubtitle.textContent = `${catName} · Historial intacto`;

      dPct.textContent = `${stats.pct.toFixed(0)}%`;
      dPctSmall.textContent = `${stats.pct.toFixed(0)}%`;
      dBalance.textContent = money(stats.balance);
      dOriginal.textContent = money(d.original);
      dPaid.textContent = money(stats.paid);
      dCat.textContent = catName;

      barFill.style.width = clamp(stats.pct, 0, 100) + '%';

      // history
      historyEl.innerHTML = '';
      const sorted = [...d.payments].sort((a,b)=> (a.date < b.date ? 1 : -1));
      if(sorted.length === 0){
        historyEl.innerHTML = `
          <div style="padding:10px;border:1px dashed var(--stroke);border-radius:16px;background:rgba(238,243,255,.55)">
            <b style="font-size:12px;display:block">Sin abonos aún</b>
            <div class="muted" style="margin-top:4px;font-size:11px">Registra un abono para empezar a ver progreso tangible.</div>
          </div>`;
      }else{
        sorted.forEach(p => {
          const row = document.createElement('div');
          row.className = 'txn';
          row.innerHTML = `
            <div class="l">
              <b>${fmtDate(p.date)}</b>
              <small>${escapeHtml(p.note || 'Abono')}</small>
            </div>
            <div class="r">
              <b>${money(p.amount)}</b>
              <small>abonado total: ${money(stats.paid)}</small>
            </div>
          `;
          historyEl.appendChild(row);
        });
      }
    }

    function renderEmptyDetail(){
      btnAddPayment.disabled = true;
      btnEditDebt.disabled = true;

      dTitle.textContent = 'Selecciona una deuda';
      dSubtitle.textContent = 'Verás monto original, total abonado, saldo real y % pagado.';
      dPct.textContent = '—';
      dPctSmall.textContent = '—';
      dBalance.textContent = '—';
      dOriginal.textContent = '—';
      dPaid.textContent = '—';
      dCat.textContent = '—';
      barFill.style.width = '0%';

      historyEl.innerHTML = `
        <div style="padding:10px;border:1px dashed var(--stroke);border-radius:16px;background:rgba(238,243,255,.55)">
          <b style="font-size:12px;display:block">Historial</b>
          <div class="muted" style="margin-top:4px;font-size:11px">Selecciona una deuda para ver sus abonos.</div>
        </div>`;
    }

    // Helpers
    function applyFilters(list){
      const cat = filterCategoryEl.value || 'all';
      const q = (qEl.value || '').trim().toLowerCase();

      return list.filter(d => {
        const okCat = (cat === 'all') ? true : d.categoryId === cat;
        const okQ = !q ? true : (d.name.toLowerCase().includes(q) || getCatName(d.categoryId).toLowerCase().includes(q));
        return okCat && okQ;
      });
    }

    function compute(d){
      const paid = (d.payments || []).reduce((s,p)=> s + Number(p.amount||0), 0);
      const balance = Math.max(0, Number(d.original||0) - paid);
      const pct = (Number(d.original||0) > 0) ? (paid / d.original * 100) : 0;
      return {paid, balance, pct: clamp(pct, 0, 999)};
    }

    function hydrateCategorySelect(selectEl, includeAll){
      selectEl.innerHTML = '';
      BASE_CATEGORIES.forEach(c => {
        if(!includeAll && c.id === 'all') return;
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        selectEl.appendChild(opt);
      });
      if(includeAll) selectEl.value = 'all';
    }

    function getCatName(id){
      return (BASE_CATEGORIES.find(c => c.id === id)?.name) || 'Categoría';
    }

    function getSelectedDebt(){
      return debts.find(d => d.id === selectedDebtId) || null;
    }

    function openModal(el){
      el.classList.add('show');
      el.setAttribute('aria-hidden', 'false');
    }
    function closeModal(el){
      el.classList.remove('show');
      el.setAttribute('aria-hidden', 'true');
    }

    function money(n){
      const v = Number(n || 0);
      return v.toLocaleString('en-US', {style:'currency', currency:'USD', maximumFractionDigits:0});
    }

    function clamp(n, a, b){ return Math.min(b, Math.max(a, n)); }

    function isoToday(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function fmtDate(iso){
      try{
        const d = new Date(iso + 'T00:00:00');
        return d.toLocaleDateString('es-US', {year:'numeric', month:'short', day:'2-digit'});
      }catch(_){
        return iso;
      }
    }

    function debounce(fn, ms){
      let t=null;
      return (...args)=>{
        clearTimeout(t);
        t=setTimeout(()=>fn(...args), ms);
      };
    }

    function shake(el){
      const old = el.style.boxShadow;
      el.style.boxShadow = '0 0 0 3px rgba(239,68,68,.25)';
      el.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],
                 {duration:220, iterations:1});
      setTimeout(()=> el.style.boxShadow = old, 420);
    }

    function cryptoId(){
      return Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);
    }

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, (m)=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }
  </script>
</body>
</html>
