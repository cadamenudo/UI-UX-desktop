<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cada Menudo ‚Äì Plan de Deuda</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --sidebar-w:280px;
      --header-h:64px;
      --primary:#3956E8;
      --secondary:#7459D9;
      --yellow:#E8C239;
      --green:#22C55E;
      --red:#EF4444;
      --orange:#F97316;
      --gray:#64748B;
      --muted:#EEF0F6;
      --bg:#F7F8FC;
      --card:#FFFFFF;
      --text:#0F172A;
      --border:#E5E7EB;
      --shadow:0 6px 18px rgba(17,24,39,.06);
      --placeholder:#94a3b8;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      font-family:"Nunito",system-ui,-apple-system,sans-serif;
      color:var(--text);
    }

    /* ===== HEADER ===== */
    header{
      position:fixed;top:0;left:0;right:0;
      height:var(--header-h);
      background:#594AE2;
      z-index:100;
      display:flex;align-items:center;justify-content:space-between;
      padding:0 20px;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    header *{color:#fff!important}
    header .logo img{height:44px;object-fit:contain}
    .usuario-header{display:flex;align-items:center;gap:10px;font-weight:700;font-size:15px}
    .usuario-header .avatar{
      width:38px;height:38px;border-radius:50%;
      background:#C7BEFF url('https://cadamenudo.github.io/UI-UX/assets/icons/user-placeholder.png') center/60% no-repeat;
      border:2px solid rgba(255,255,255,.3);
    }

    /* ===== MAIN ===== */
    main{
      margin-top:var(--header-h);
      padding:24px;
      max-width:1320px;
      margin-left:auto;
      margin-right:auto;
    }
    .card{
      background:#fff;
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:18px;
    }

    /* ===== TOPBAR ===== */
    .topbar{
      display:flex;align-items:flex-start;
      justify-content:space-between;gap:16px;
      margin-bottom:16px;
    }
    .title h1{margin:0;font-size:22px;font-weight:900;letter-spacing:.2px}
    .title p{margin:4px 0 0;color:var(--gray);font-weight:700;font-size:13px}
    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .search{
      width:360px;max-width:46vw;
      display:flex;align-items:center;gap:10px;
      border:1px solid var(--border);border-radius:12px;
      background:#fff;padding:10px 12px;
    }
    .search .k{color:var(--gray);font-weight:900;font-size:12px}
    .search input{
      width:100%;border:0;outline:none;
      font-family:"Nunito",sans-serif;font-weight:700;
      font-size:14px;color:var(--text);
    }
    input::placeholder{color:var(--placeholder);font-weight:700}
    .btn{
      border:0;border-radius:12px;padding:10px 14px;
      font-weight:900;cursor:pointer;
      font-family:"Nunito",sans-serif;letter-spacing:.2px;
      font-size:14px;
      transition:transform .1s,box-shadow .15s;
    }
    .btn.primary{background:#594AE2;color:#fff;box-shadow:0 10px 18px rgba(89,74,226,.22)}
    .btn.primary:hover{box-shadow:0 14px 24px rgba(89,74,226,.32)}
    .btn.ghost{background:#fff;color:var(--gray);border:1px solid var(--border)}
    .btn.danger-ghost{background:#fff;color:var(--red);border:1px solid rgba(239,68,68,.3)}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}

    /* ===== BANNER RESUMEN ===== */
    .banner-wrap{margin-bottom:18px}
    .banner-grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
    }
    .banner-block{
      display:flex;align-items:center;gap:12px;
      background:#fff;border:1px solid var(--border);
      border-radius:16px;padding:14px 16px;
      box-shadow:var(--shadow);
    }
    .banner-block.urgent{
      border-color:rgba(239,68,68,.25);
      background:rgba(239,68,68,.03);
    }
    .ico{
      width:40px;height:40px;border-radius:12px;
      display:grid;place-items:center;font-weight:900;
      color:var(--primary);background:rgba(57,86,232,.10);
      border:1px solid rgba(57,86,232,.18);flex:0 0 40px;font-size:16px;
    }
    .ico.yellow{color:#8a6a00;background:rgba(232,194,57,.22);border-color:rgba(232,194,57,.35)}
    .ico.green{color:#15803d;background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.3)}
    .ico.red{color:#b91c1c;background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.25)}
    .metric .label{font-size:12px;color:var(--gray);font-weight:800;letter-spacing:.02em;margin-bottom:5px}
    .metric .value{font-size:19px;font-weight:900;color:var(--text);letter-spacing:.2px}
    .metric .sub{margin-top:4px;font-size:11px;color:var(--gray);font-weight:700}
    .metric .sub.urgent-sub{color:var(--red);font-weight:800}

    /* ===== SORT BAR ===== */
    .sort-bar{
      display:flex;align-items:center;gap:8px;
      margin-top:10px;margin-bottom:4px;
    }
    .sort-bar span{font-size:12px;font-weight:800;color:var(--gray)}
    .sort-btn{
      padding:5px 10px;border-radius:8px;border:1px solid var(--border);
      background:#fff;font-family:"Nunito",sans-serif;
      font-size:12px;font-weight:800;color:var(--gray);cursor:pointer;
      transition:all .15s;
    }
    .sort-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .sort-btn:hover:not(.active){background:var(--muted)}

    /* ===== GRID PRINCIPAL ===== */
    .grid{
      display:grid;
      grid-template-columns:440px 1fr;
      gap:20px;align-items:start;
    }
    .card-head{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;margin-bottom:12px;
    }
    .card-head h3{margin:0;font-size:16px;font-weight:900}
    .meta{color:var(--gray);font-weight:800;font-size:12px}

    .field label{
      display:block;font-size:12px;color:var(--gray);
      text-transform:uppercase;letter-spacing:.1em;
      margin:0 0 6px 2px;font-weight:800;
    }
    .field select,.field input{
      width:100%;border:1px solid var(--border);border-radius:12px;
      padding:10px 12px;background:#fff;
      font-family:"Nunito",sans-serif;font-weight:700;
      color:var(--text);outline:none;font-size:14px;
    }
    .field select:focus,.field input:focus{
      border-color:rgba(89,74,226,.5);
      box-shadow:0 0 0 3px rgba(89,74,226,.1);
    }

    /* ===== LISTA DEUDAS ===== */
    .debtList{
      margin-top:10px;display:flex;flex-direction:column;gap:8px;
      max-height:62vh;overflow:auto;padding-right:2px;
    }
    .debtItem{
      display:grid;grid-template-columns:auto 1fr auto;
      gap:10px;align-items:center;
      padding:11px 12px;border:1px solid var(--border);
      border-radius:14px;background:#fff;cursor:pointer;
      transition:background .15s,border-color .15s;
    }
    .debtItem:hover{background:var(--muted)}
    .debtItem.active{background:rgba(57,86,232,.07);border-color:rgba(57,86,232,.2)}

    /* Status dot */
    .status-dot{
      width:10px;height:10px;border-radius:50%;flex:0 0 10px;
      margin-top:2px;
    }
    .status-dot.ok{background:var(--green)}
    .status-dot.warn{background:var(--orange)}
    .status-dot.over{background:var(--red)}
    .status-dot.none{background:#CBD5E1}

    .dname{font-weight:900;font-size:14px}
    .dsub{margin-top:3px;color:var(--gray);font-weight:700;font-size:12px}
    .amountCol{text-align:right;min-width:120px}
    .amountCol .amt{font-weight:900;font-size:14px}
    .amountCol .mini{margin-top:3px;color:var(--gray);font-weight:800;font-size:12px}
    .amountCol .mini.hot{color:var(--red);font-weight:900}

    /* ===== DETALLE ===== */
    .hero{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      margin-bottom:14px;
    }
    .hero h4{margin:0;font-size:18px;font-weight:900}
    .hero p{margin:5px 0 0;color:var(--gray);font-weight:700;font-size:13px}

    .progressBox{
      border:1px solid var(--border);border-radius:16px;
      padding:16px;background:#fff;
    }
    .progTop{
      display:flex;align-items:flex-end;justify-content:space-between;
      gap:12px;margin-bottom:12px;
    }
    .bigPct{font-size:28px;font-weight:900;letter-spacing:.2px}
    .bigBal .lbl{color:var(--gray);font-weight:800;font-size:12px;text-transform:uppercase;letter-spacing:.1em}
    .bigBal .val{font-size:18px;font-weight:900;margin-top:5px}

    .bar{
      width:100%;height:12px;border-radius:999px;
      background:#E9ECF6;overflow:hidden;border:1px solid var(--border);
    }
    .bar>div{
      height:100%;width:0%;
      background:linear-gradient(90deg,var(--primary),var(--secondary));
      border-radius:999px;transition:width .45s cubic-bezier(.4,0,.2,1);
    }

    /* Insight de ritmo */
    .insight-box{
      margin-top:10px;padding:10px 14px;
      background:rgba(57,86,232,.06);border:1px solid rgba(57,86,232,.15);
      border-radius:12px;
      display:flex;align-items:flex-start;gap:10px;
    }
    .insight-box .ib-icon{font-size:16px;flex:0 0 20px;margin-top:1px}
    .insight-box .ib-text{font-size:13px;font-weight:700;color:var(--text);line-height:1.5}
    .insight-box .ib-text span{color:var(--primary);font-weight:900}
    .insight-box.warn-insight{
      background:rgba(249,115,22,.06);
      border-color:rgba(249,115,22,.2);
    }
    .insight-box.warn-insight .ib-text span{color:var(--orange)}

    .metrics{
      display:grid;grid-template-columns:repeat(4,1fr);
      gap:10px;margin-top:12px;
    }
    .m{border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff}
    .m .k{font-size:11px;color:var(--gray);font-weight:900;text-transform:uppercase;letter-spacing:.1em}
    .m .v{margin-top:7px;font-weight:900;font-size:14px}
    .m .v.red{color:var(--red)}
    .m .v.green{color:#15803d}

    .box{
      margin-top:14px;border:1px solid var(--border);
      border-radius:16px;padding:14px;background:#fff;
    }
    .box-header{
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:10px;
    }
    .box .box-title{font-weight:900;margin:0;font-size:13px;color:var(--text)}
    .history-total{
      font-size:12px;font-weight:900;
      color:var(--primary);
      background:rgba(57,86,232,.09);
      border:1px solid rgba(57,86,232,.18);
      border-radius:8px;padding:4px 10px;
    }

    .history{display:flex;flex-direction:column;gap:8px;max-height:280px;overflow:auto;padding-right:2px}
    .tx{
      display:grid;grid-template-columns:1fr auto;
      gap:8px;align-items:center;
      padding:10px 12px;border:1px solid var(--border);
      border-radius:12px;background:#fff;
    }
    .tx b{font-weight:900;font-size:13px}
    .tx small{display:block;margin-top:3px;color:var(--gray);font-weight:700;font-size:12px}
    .tx .amt{font-weight:900;font-size:14px;color:#15803d}

    /* ===== ESTADO VAC√çO MEJORADO ===== */
    .empty-state{
      display:flex;flex-direction:column;align-items:center;
      justify-content:center;padding:28px 16px;gap:10px;
      text-align:center;
    }
    .empty-state .e-icon{font-size:32px}
    .empty-state b{font-size:15px;font-weight:900}
    .empty-state p{margin:0;font-size:13px;color:var(--gray);font-weight:700}
    .empty-state button{margin-top:4px}

    /* ===== TOAST / CELEBRACI√ìN ===== */
    .toast{
      position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);
      background:#1e293b;color:#fff;
      padding:12px 20px;border-radius:14px;
      font-weight:800;font-size:14px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
      z-index:500;transition:transform .35s cubic-bezier(.4,0,.2,1),opacity .35s;
      opacity:0;pointer-events:none;display:flex;align-items:center;gap:10px;
    }
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .toast .t-emoji{font-size:18px}

    /* ===== CONFETTI ===== */
    .confetti-wrap{
      position:fixed;inset:0;pointer-events:none;z-index:450;overflow:hidden;
    }
    .confetti-piece{
      position:absolute;width:8px;height:8px;border-radius:2px;
      animation:confettiFall 1.2s ease-in forwards;
      opacity:0;
    }
    @keyframes confettiFall{
      0%{transform:translateY(-20px) rotate(0deg);opacity:1}
      100%{transform:translateY(100vh) rotate(720deg);opacity:0}
    }

    /* ===== MODAL ===== */
    .overlay{
      position:fixed;inset:0;background:rgba(15,23,42,.45);
      display:none;align-items:center;justify-content:center;
      padding:18px;z-index:200;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(560px,96vw);border-radius:18px;background:#fff;
      box-shadow:0 22px 60px rgba(0,0,0,.25);
      overflow:hidden;border:1px solid var(--border);
      animation:modalIn .2s cubic-bezier(.34,1.56,.64,1);
    }
    @keyframes modalIn{
      from{transform:scale(.92);opacity:0}
      to{transform:scale(1);opacity:1}
    }
    .modalHd{
      padding:14px 16px;background:#F3F4FF;
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .modalHd b{font-size:14px;font-weight:900;color:var(--text)}
    .xBtn{
      width:34px;height:34px;border-radius:10px;border:1px solid var(--border);
      background:#fff;cursor:pointer;font-weight:900;color:var(--gray);font-size:14px;
      display:grid;place-items:center;
    }
    .xBtn:hover{background:var(--muted)}
    .modalBd{padding:14px 16px 4px}
    .modalGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .modalFoot{
      padding:12px 16px 16px;
      display:flex;justify-content:space-between;gap:10px;
      align-items:center;
    }
    .modalFoot .left-actions{display:flex;gap:8px}
    .modalFoot .right-actions{display:flex;gap:8px}

    .source-note{
      display:flex;align-items:flex-start;gap:8px;
      padding:9px 12px;margin-bottom:10px;
      background:#F8F9FF;border:1px solid rgba(57,86,232,.12);
      border-radius:10px;font-size:12px;font-weight:700;
      color:var(--gray);line-height:1.5;
    }
    .source-note strong{color:var(--primary)}

    /* ===== MOBILE TABS ===== */
    .mobile-tabs{
      display:none;
      border-bottom:2px solid var(--border);
      margin-bottom:14px;
    }
    .tab-btn{
      padding:10px 16px;border:none;background:none;
      font-family:"Nunito",sans-serif;font-weight:900;font-size:14px;
      color:var(--gray);cursor:pointer;border-bottom:2px solid transparent;
      margin-bottom:-2px;transition:color .15s,border-color .15s;
    }
    .tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}

    /* ===== STATUS BADGE ===== */
    .status-badge{
      display:inline-flex;align-items:center;gap:5px;
      padding:3px 8px;border-radius:6px;font-size:11px;font-weight:900;
    }
    .status-badge.ok{background:rgba(34,197,94,.12);color:#15803d}
    .status-badge.warn{background:rgba(249,115,22,.12);color:#c2410c}
    .status-badge.over{background:rgba(239,68,68,.12);color:#b91c1c}
    .status-badge.none{background:var(--muted);color:var(--gray)}

    /* ===== RESPONSIVE ===== */
    @media(max-width:1100px){
      .grid{grid-template-columns:1fr}
      .search{width:100%;max-width:none}
      .metrics{grid-template-columns:1fr 1fr}
      .banner-grid{grid-template-columns:1fr 1fr}
      .mobile-tabs{display:flex}
      .panel-lista,.panel-detalle{display:none}
      .panel-lista.tab-active,.panel-detalle.tab-active{display:block}
    }
    @media(max-width:600px){
      .topbar{flex-direction:column;gap:10px}
      .actions{width:100%;justify-content:flex-start}
      .search{width:100%;max-width:none}
      .banner-grid{grid-template-columns:1fr 1fr}
      .metrics{grid-template-columns:1fr 1fr}
      .modalGrid{grid-template-columns:1fr}
    }
    @media(max-width:440px){
      .banner-grid{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <header>
    <div class="logo">
      <img src="https://cadamenudo.github.io/UI-UX/assets/icons/nueva.png" alt="Cada Menudo"/>
    </div>
    <div class="usuario-header">
      <div class="avatar" aria-hidden="true"></div>
      <div>Mi perfil</div>
    </div>
  </header>

  <main>
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="title">
        <h1>Plan de deuda</h1>
        <p>Rastrea cada deuda, cada abono, cada paso hacia la libertad financiera.</p>
      </div>
      <div class="actions">
        <div class="search" role="search">
          <span class="k">‚åï</span>
          <input id="q" type="text" placeholder="Buscar (Visa, Auto, Universidad‚Ä¶)" aria-label="Buscar deuda"/>
          <span class="k" style="opacity:.5">‚åòK</span>
        </div>
        <button class="btn primary" id="btnNewDebt" type="button">+ Nueva deuda</button>
      </div>
    </div>

    <!-- BANNER -->
    <section class="banner-wrap" aria-label="Resumen de deuda">
      <div class="banner-grid">
        <div class="banner-block">
          <div class="ico">Œ£</div>
          <div class="metric">
            <div class="label">Total deuda</div>
            <div class="value" id="sumTotalDebt">$0</div>
            <div class="sub">Monto original acumulado</div>
          </div>
        </div>
        <div class="banner-block">
          <div class="ico green">‚úì</div>
          <div class="metric">
            <div class="label">Total abonado</div>
            <div class="value" id="sumTotalPaid">$0</div>
            <div class="sub" id="sumPaidPct">‚Äî del total</div>
          </div>
        </div>
        <div class="banner-block">
          <div class="ico yellow">‚Üò</div>
          <div class="metric">
            <div class="label">Falta por pagar</div>
            <div class="value" id="sumTotalRemaining">$0</div>
            <div class="sub">Saldo real acumulado</div>
          </div>
        </div>
        <div class="banner-block urgent">
          <div class="ico red">‚ö°</div>
          <div class="metric">
            <div class="label">Deuda urgente</div>
            <div class="value" id="urgentName">‚Äî</div>
            <div class="sub urgent-sub" id="urgentSub">Mayor APR activo</div>
          </div>
        </div>
      </div>
    </section>

    <!-- GRID -->
    <section class="grid">
      <!-- PANEL LISTA -->
      <div class="card panel-lista tab-active" id="panelLista">
        <div class="card-head">
          <h3>Mis deudas</h3>
          <div class="meta"><span id="countDebts">0</span> registradas</div>
        </div>

        <div class="field">
          <label for="filterCategory">Filtrar por categor√≠a</label>
          <select id="filterCategory"></select>
        </div>

        <!-- Sort bar -->
        <div class="sort-bar">
          <span>Ordenar:</span>
          <button class="sort-btn active" data-sort="balance" type="button">Mayor saldo</button>
          <button class="sort-btn" data-sort="apr" type="button">Mayor APR</button>
          <button class="sort-btn" data-sort="pct" type="button">Menos pagado</button>
          <button class="sort-btn" data-sort="name" type="button">A-Z</button>
        </div>

        <div class="debtList" id="debtList"></div>
      </div>

      <!-- PANEL DETALLE -->
      <div class="card panel-detalle tab-active" id="panelDetalle">
        <!-- Mobile tabs (solo visibles en mobile) -->
        <div class="mobile-tabs">
          <button class="tab-btn" id="tabLista" type="button" onclick="showMobileTab('lista')">‚Üê Lista</button>
          <button class="tab-btn active" id="tabDetalle" type="button" onclick="showMobileTab('detalle')">Detalle</button>
        </div>

        <div class="hero">
          <div>
            <h4 id="dTitle">Selecciona una deuda</h4>
            <p id="dSubtitle">Elige una deuda de la lista para ver su progreso y registrar abonos.</p>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="btn ghost" id="btnEditDebt" type="button" disabled>Editar</button>
          </div>
        </div>

        <div class="progressBox">
          <div class="progTop">
            <div>
              <div class="meta" style="text-transform:uppercase;letter-spacing:.1em">Porcentaje pagado</div>
              <div class="bigPct" id="dPct">‚Äî</div>
            </div>
            <div class="bigBal">
              <div class="lbl">Saldo actual</div>
              <div class="val" id="dBalance">‚Äî</div>
            </div>
          </div>
          <div class="bar"><div id="barFill"></div></div>
          <div id="insightBox"></div>

          <div class="metrics">
            <div class="m">
              <div class="k">Monto original</div>
              <div class="v" id="dOriginal">‚Äî</div>
            </div>
            <div class="m">
              <div class="k">Total abonado</div>
              <div class="v green" id="dPaid">‚Äî</div>
            </div>
            <div class="m">
              <div class="k">APR / inter√©s</div>
              <div class="v" id="dApr">‚Äî</div>
            </div>
            <div class="m">
              <div class="k">Costo mensual</div>
              <div class="v red" id="dMonthlyCost">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="box-header">
            <div class="box-title">Historial de abonos</div>
            <div class="history-total" id="historyTotal" style="display:none"></div>
          </div>
          <div class="source-note">
            <span>üì•</span>
            <span>Los abonos se registran autom√°ticamente desde <strong>Mis Gastos</strong> al categorizar un pago hacia esta deuda.</span>
          </div>
          <div class="history" id="history"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- TOAST -->
  <div class="toast" id="toast" aria-live="polite">
    <span class="t-emoji" id="toastEmoji">üéâ</span>
    <span id="toastMsg">¬°Abono registrado!</span>
  </div>

  <!-- CONFETTI WRAP -->
  <div class="confetti-wrap" id="confettiWrap"></div>

  <!-- MODAL: NUEVA / EDITAR DEUDA -->
  <div class="overlay" id="overlayDebt" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="debtTitle">
      <div class="modalHd">
        <b id="debtTitle">Nueva deuda</b>
        <button class="xBtn" id="closeDebt" type="button" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="modalBd">
        <div class="modalGrid">
          <div class="field">
            <label for="newName">Nombre</label>
            <input id="newName" type="text" placeholder="Ej. Visa, Pr√©stamo auto‚Ä¶"/>
          </div>
          <div class="field">
            <label for="newCategory">Categor√≠a</label>
            <select id="newCategory"></select>
          </div>
          <div class="field">
            <label for="newOriginal">Monto original ($)</label>
            <input id="newOriginal" type="number" min="0" step="0.01" placeholder="Ej. 5000"/>
          </div>
          <div class="field">
            <label for="newApr">APR / inter√©s anual (%)</label>
            <input id="newApr" type="number" min="0" step="0.01" placeholder="Ej. 24.99 ¬∑ d√©jalo en 0 si no aplica"/>
          </div>
          <div class="field" style="grid-column:1 / -1">
            <label for="newNote">Nota</label>
            <input id="newNote" type="text" placeholder="Informaci√≥n adicional (opcional)"/>
          </div>
        </div>
      </div>
      <div class="modalFoot">
        <div class="left-actions">
          <button class="btn danger-ghost" id="deleteDebtBtn" type="button" style="display:none">üóë Eliminar</button>
        </div>
        <div class="right-actions">
          <button class="btn ghost" id="cancelDebt" type="button">Cancelar</button>
          <button class="btn primary" id="saveDebt" type="button">Crear deuda</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CONFIRM DELETE -->
  <div class="overlay" id="overlayConfirm" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width:400px">
      <div class="modalHd">
        <b>¬øEliminar esta deuda?</b>
        <button class="xBtn" id="closeConfirm" type="button">‚úï</button>
      </div>
      <div class="modalBd" style="padding:16px">
        <p style="margin:0;font-size:14px;font-weight:700;color:var(--gray);line-height:1.6">
          Esta acci√≥n eliminar√° la deuda y todo su historial de abonos. Esta acci√≥n no se puede deshacer.
        </p>
      </div>
      <div class="modalFoot">
        <div class="left-actions"></div>
        <div class="right-actions">
          <button class="btn ghost" id="cancelConfirm" type="button">Cancelar</button>
          <button class="btn" id="confirmDelete" type="button" style="background:var(--red);color:#fff">S√≠, eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const BASE_CATEGORIES = [
      {id:'tarjetas',      name:'Tarjetas de cr√©dito'},
      {id:'linea_personal',name:'L√≠nea cr√©dito personal'},
      {id:'linea_propiedad',name:'L√≠nea cr√©dito de la propiedad'},
      {id:'casa',          name:'Hipoteca / Casa'},
      {id:'otras_propiedades',name:'Otras propiedades'},
      {id:'auto',          name:'Auto'},
      {id:'educacion',     name:'Educaci√≥n'},
      {id:'muebles',       name:'Muebles y enseres'},
      {id:'mejoras',       name:'Mejoras al hogar'},
      {id:'seguro_vida',   name:'Seguro de vida'},
      {id:'margen_broker', name:'Margen con corretaje'},
      {id:'otros',         name:'Otros'},
    ];

    let debts = [
      { id:rid(), name:'Visa ‚Äì Banco Popular', categoryId:'tarjetas', original:8200, apr:24.99, note:'',
        payments:[{date:'2026-01-10',amount:250,note:'Pago m√≠nimo'},{date:'2026-02-05',amount:400,note:'Pago extra'}]},
      { id:rid(), name:'Pr√©stamo Auto', categoryId:'auto', original:14500, apr:7.5, note:'',
        payments:[{date:'2026-01-15',amount:375,note:'Pago mensual'},{date:'2026-02-15',amount:375,note:'Pago mensual'}]},
      { id:rid(), name:'Pr√©stamo Universidad', categoryId:'educacion', original:5200, apr:0, note:'',
        payments:[{date:'2026-02-01',amount:200,note:'Abono'}]},
    ];

    let selectedDebtId = null;
    let currentSort = 'balance';
    let editingDebtId = null;

    // DOM refs
    const debtListEl     = document.getElementById('debtList');
    const countDebtsEl   = document.getElementById('countDebts');
    const filterCatEl    = document.getElementById('filterCategory');
    const qEl            = document.getElementById('q');
    const dTitle         = document.getElementById('dTitle');
    const dSubtitle      = document.getElementById('dSubtitle');
    const dPct           = document.getElementById('dPct');
    const dBalance       = document.getElementById('dBalance');
    const dOriginal      = document.getElementById('dOriginal');
    const dPaid          = document.getElementById('dPaid');
    const dApr           = document.getElementById('dApr');
    const dMonthlyCost   = document.getElementById('dMonthlyCost');
    const barFill        = document.getElementById('barFill');
    const historyEl      = document.getElementById('history');
    const historyTotal   = document.getElementById('historyTotal');
    const insightBox     = document.getElementById('insightBox');
    const btnEditDebt    = document.getElementById('btnEditDebt');

    const sumTotalDebt      = document.getElementById('sumTotalDebt');
    const sumTotalPaid      = document.getElementById('sumTotalPaid');
    const sumTotalRemaining = document.getElementById('sumTotalRemaining');
    const sumPaidPct        = document.getElementById('sumPaidPct');
    const urgentName        = document.getElementById('urgentName');
    const urgentSub         = document.getElementById('urgentSub');

    const overlayDebt    = document.getElementById('overlayDebt');
    const overlayConfirm = document.getElementById('overlayConfirm');


    const newName     = document.getElementById('newName');
    const newCategory = document.getElementById('newCategory');
    const newOriginal = document.getElementById('newOriginal');
    const newApr      = document.getElementById('newApr');
    const newNote     = document.getElementById('newNote');
    const debtTitle   = document.getElementById('debtTitle');
    const saveDebt    = document.getElementById('saveDebt');
    const deleteDebtBtn = document.getElementById('deleteDebtBtn');

    // Init
    buildCategorySelect(filterCatEl, true);
    buildCategorySelect(newCategory, false);
    render();
    if(debts.length > 0){ selectedDebtId = debts[0].id; render(); }

    // Sort buttons
    document.querySelectorAll('.sort-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentSort = btn.dataset.sort;
        render();
      });
    });

    filterCatEl.addEventListener('change', render);
    qEl.addEventListener('input', debounce(render, 120));

    // Nueva deuda ‚Üí navega a p√°gina dedicada
    document.getElementById('btnNewDebt').addEventListener('click', () => {
      window.location.href = 'nueva-deuda.html';
    });

    // Editar deuda
    btnEditDebt.addEventListener('click', () => {
      const d = getSelectedDebt();
      if(!d) return;
      editingDebtId = d.id;
      debtTitle.textContent = 'Editar deuda';
      saveDebt.textContent = 'Guardar cambios';
      deleteDebtBtn.style.display = 'flex';
      newName.value = d.name;
      newCategory.value = d.categoryId;
      newOriginal.value = d.original;
      newApr.value = d.apr || '';
      newNote.value = d.note || '';
      openModal(overlayDebt);
      setTimeout(() => newName.focus(), 50);
    });

    document.getElementById('closeDebt').addEventListener('click', () => closeModal(overlayDebt));
    document.getElementById('cancelDebt').addEventListener('click', () => closeModal(overlayDebt));
    document.getElementById('closeConfirm').addEventListener('click', () => closeModal(overlayConfirm));
    document.getElementById('cancelConfirm').addEventListener('click', () => closeModal(overlayConfirm));

    // Guardar / editar deuda
    saveDebt.addEventListener('click', () => {
      const name = (newName.value || '').trim();
      const cat  = newCategory.value;
      const orig = Number(newOriginal.value || 0);
      const apr  = Number(newApr.value || 0);
      const note = (newNote.value || '').trim();
      if(!name){ shake(newName); newName.focus(); return; }
      if(orig <= 0){ shake(newOriginal); newOriginal.focus(); return; }

      if(editingDebtId){
        const d = debts.find(d => d.id === editingDebtId);
        if(d){ d.name = name; d.categoryId = cat; d.original = orig; d.apr = apr; d.note = note; }
      } else {
        debts.unshift({id:rid(), name, categoryId:cat, original:orig, apr, note, payments:[]});
        selectedDebtId = debts[0].id;
      }
      closeModal(overlayDebt);
      render();
    });

    // Eliminar deuda
    deleteDebtBtn.addEventListener('click', () => {
      closeModal(overlayDebt);
      openModal(overlayConfirm);
    });

    document.getElementById('confirmDelete').addEventListener('click', () => {
      debts = debts.filter(d => d.id !== editingDebtId);
      if(selectedDebtId === editingDebtId) selectedDebtId = debts[0]?.id || null;
      editingDebtId = null;
      closeModal(overlayConfirm);
      showToast('üóë', 'Deuda eliminada.');
      render();
    });

    // Keyboard
    document.addEventListener('keydown', e => {
      const k = e.key.toLowerCase();
      if((e.metaKey || e.ctrlKey) && k === 'k'){ e.preventDefault(); qEl.focus(); }
      if(k === 'escape'){
        closeModal(overlayDebt);
        closeModal(overlayConfirm);
      }
    });

    [overlayDebt, overlayConfirm].forEach(ov => {
      ov.addEventListener('click', e => { if(e.target === ov) closeModal(ov); });
    });

    // ===== RENDER =====
    function render(){
      renderSummary();
      renderList();
      countDebtsEl.textContent = debts.length;
      const sel = getSelectedDebt();
      if(sel) renderDetail(sel);
      else     renderEmptyDetail();
    }

    function renderSummary(){
      const totals = debts.reduce((acc, d) => {
        const paid = totalPaid(d);
        acc.original += Number(d.original || 0);
        acc.paid += paid;
        return acc;
      }, {original:0, paid:0});

      const remaining = Math.max(0, totals.original - totals.paid);
      const pct = totals.original > 0 ? (totals.paid / totals.original * 100) : 0;

      sumTotalDebt.textContent      = money(totals.original);
      sumTotalPaid.textContent      = money(totals.paid);
      sumTotalRemaining.textContent = money(remaining);
      sumPaidPct.textContent        = `${pct.toFixed(0)}% del total pagado`;

      // Deuda urgente = mayor APR con saldo > 0
      const withBalance = debts.filter(d => {
        const paid = totalPaid(d);
        return (d.original - paid) > 0 && d.apr > 0;
      }).sort((a,b) => b.apr - a.apr);

      if(withBalance.length > 0){
        urgentName.textContent = withBalance[0].name;
        urgentSub.textContent  = `${withBalance[0].apr}% APR ¬∑ at√°cala primero`;
      } else if(debts.length > 0){
        const noAprDebt = debts.filter(d => totalPaid(d) < d.original);
        urgentName.textContent = noAprDebt.length > 0 ? noAprDebt[0].name : '‚Äî';
        urgentSub.textContent  = 'Mayor saldo pendiente';
      } else {
        urgentName.textContent = '‚Äî';
        urgentSub.textContent  = 'Mayor APR activo';
      }
    }

    function renderList(){
      let filtered = applyFilters(debts);
      filtered = sortDebts(filtered);
      debtListEl.innerHTML = '';

      if(filtered.length === 0){
        debtListEl.innerHTML = `
          <div class="empty-state">
            <div class="e-icon">üîç</div>
            <b>Sin resultados</b>
            <p>Ajusta los filtros o busca otro t√©rmino.</p>
          </div>`;
        return;
      }

      filtered.forEach(d => {
        const stats    = compute(d);
        const catName  = getCatName(d.categoryId);
        const active   = d.id === selectedDebtId;
        const status   = getStatus(d);

        const row = document.createElement('div');
        row.className = 'debtItem' + (active ? ' active' : '');
        row.setAttribute('role','button');
        row.setAttribute('tabindex','0');
        row.innerHTML = `
          <div class="status-dot ${status.cls}" title="${status.label}"></div>
          <div>
            <div class="dname">${esc(d.name)}</div>
            <div class="dsub">${esc(catName)}${d.apr ? ' ¬∑ '+d.apr.toFixed(2)+'% APR' : ''}</div>
          </div>
          <div class="amountCol">
            <div class="amt">${money(stats.balance)}</div>
            <div class="mini ${d.apr > 15 ? 'hot' : ''}">${stats.pct.toFixed(0)}% pagado</div>
          </div>
        `;
        const select = () => {
          selectedDebtId = d.id;
          render();
          // Mobile: switch to detail tab
          if(window.innerWidth <= 1100) showMobileTab('detalle');
        };
        row.addEventListener('click', select);
        row.addEventListener('keydown', e => { if(e.key==='Enter'||e.key===' ') select(); });
        debtListEl.appendChild(row);
      });
    }

    function renderDetail(d){
      btnEditDebt.disabled   = false;

      const stats    = compute(d);
      const catName  = getCatName(d.categoryId);
      const status   = getStatus(d);

      dTitle.innerHTML = `${esc(d.name)} <span class="status-badge ${status.cls}">${status.label}</span>`;
      dSubtitle.textContent = catName + (d.note ? ' ¬∑ ' + d.note : '');

      dPct.textContent        = `${stats.pct.toFixed(0)}%`;
      dBalance.textContent    = money(stats.balance);
      dOriginal.textContent   = money(d.original);
      dPaid.textContent       = money(stats.paid);
      dApr.textContent        = d.apr ? d.apr.toFixed(2) + '%' : 'Sin APR';
      barFill.style.width     = clamp(stats.pct, 0, 100) + '%';

      // Costo mensual en intereses
      if(d.apr > 0 && stats.balance > 0){
        const monthlyInterest = (stats.balance * (d.apr / 100)) / 12;
        dMonthlyCost.textContent = money(monthlyInterest) + '/mes';
      } else {
        dMonthlyCost.textContent = '‚Äî';
      }

      // Insight de ritmo
      renderInsight(d, stats);

      // Historial
      historyEl.innerHTML = '';
      const sorted = [...(d.payments||[])].sort((a,b) => a.date < b.date ? 1 : -1);

      if(sorted.length === 0){
        historyTotal.style.display = 'none';
        historyEl.innerHTML = `
          <div class="empty-state">
            <div class="e-icon">üí≥</div>
            <b>Sin abonos registrados a√∫n</b>
            <p>Los abonos aparecen aqu√≠ autom√°ticamente cuando registras un gasto categorizado como pago de esta deuda.</p>
          </div>`;
        return;
      }

      historyTotal.style.display = 'block';
      historyTotal.textContent   = `Total: ${money(stats.paid)}`;

      sorted.forEach(p => {
        const item = document.createElement('div');
        item.className = 'tx';
        item.innerHTML = `
          <div>
            <b>${fmtDate(p.date)}</b>
            <small>${esc(p.note || 'Abono')}</small>
          </div>
          <div class="amt">${money(p.amount)}</div>
        `;
        historyEl.appendChild(item);
      });
    }

    function renderInsight(d, stats){
      insightBox.innerHTML = '';
      if(stats.balance <= 0){
        insightBox.innerHTML = `
          <div class="insight-box" style="background:rgba(34,197,94,.07);border-color:rgba(34,197,94,.25);margin-top:10px">
            <span class="ib-icon">üèÜ</span>
            <div class="ib-text"><span>¬°Deuda pagada completamente!</span> Historial intacto para tus registros.</div>
          </div>`;
        return;
      }

      // Ritmo promedio mensual de abonos
      const payments = d.payments || [];
      if(payments.length < 2){ return; }

      const amounts  = payments.map(p => Number(p.amount));
      const avgPayment = amounts.reduce((s,a) => s+a,0) / amounts.length;
      const monthsLeft = avgPayment > 0 ? Math.ceil(stats.balance / avgPayment) : null;

      if(monthsLeft && monthsLeft > 0 && monthsLeft < 600){
        const years  = Math.floor(monthsLeft / 12);
        const months = monthsLeft % 12;
        let timeStr  = '';
        if(years > 0 && months > 0) timeStr = `${years} a√±o${years>1?'s':''} y ${months} mes${months>1?'es':''}`;
        else if(years > 0)          timeStr = `${years} a√±o${years>1?'s':''}`;
        else                        timeStr = `${months} mes${months>1?'es':''}`;

        const extraPayment = avgPayment * 0.2;
        const monthsWithExtra = Math.ceil(stats.balance / (avgPayment + extraPayment));
        const saved = monthsLeft - monthsWithExtra;

        const isLong = monthsLeft > 24;

        insightBox.innerHTML = `
          <div class="insight-box ${isLong ? 'warn-insight' : ''}" style="margin-top:10px">
            <span class="ib-icon">${isLong ? '‚è≥' : 'üìà'}</span>
            <div class="ib-text">
              A tu ritmo actual, terminas en <span>~${timeStr}</span>.
              Si abon√°s <span>${money(extraPayment)}</span> extra al mes, acabas <span>${saved} mes${saved!==1?'es':'s'} antes</span>.
            </div>
          </div>`;
      }
    }

    function renderEmptyDetail(){
      btnEditDebt.disabled   = true;
      dTitle.textContent     = 'Selecciona una deuda';
      dSubtitle.textContent  = 'Elige una deuda de la lista para ver su progreso y registrar abonos.';
      dPct.textContent       = '‚Äî';
      dBalance.textContent   = '‚Äî';
      dOriginal.textContent  = '‚Äî';
      dPaid.textContent      = '‚Äî';
      dApr.textContent       = '‚Äî';
      dMonthlyCost.textContent = '‚Äî';
      barFill.style.width    = '0%';
      insightBox.innerHTML   = '';
      historyTotal.style.display = 'none';
      historyEl.innerHTML = `
        <div class="empty-state">
          <div class="e-icon">üìã</div>
          <b>Nada seleccionado</b>
          <p>Selecciona una deuda para ver el historial de abonos.</p>
        </div>`;
    }

    // ===== HELPERS =====
    function applyFilters(list){
      const cat = filterCatEl.value || 'all';
      const q   = (qEl.value || '').trim().toLowerCase();
      return list.filter(d => {
        const okCat = (cat === 'all') || d.categoryId === cat;
        const okQ   = !q || d.name.toLowerCase().includes(q) || getCatName(d.categoryId).toLowerCase().includes(q);
        return okCat && okQ;
      });
    }

    function sortDebts(list){
      return [...list].sort((a,b) => {
        const sa = compute(a), sb = compute(b);
        if(currentSort === 'balance') return sb.balance - sa.balance;
        if(currentSort === 'apr')     return (b.apr||0) - (a.apr||0);
        if(currentSort === 'pct')     return sa.pct - sb.pct;
        if(currentSort === 'name')    return a.name.localeCompare(b.name, 'es');
        return 0;
      });
    }

    function compute(d){
      const paid    = totalPaid(d);
      const balance = Math.max(0, Number(d.original||0) - paid);
      const pct     = Number(d.original||0) > 0 ? (paid / d.original * 100) : 0;
      return {paid, balance, pct};
    }

    function totalPaid(d){
      return (d.payments||[]).reduce((s,p) => s + Number(p.amount||0), 0);
    }

    function getStatus(d){
      const paid    = totalPaid(d);
      const balance = d.original - paid;
      if(balance <= 0)           return {cls:'ok',   label:'Pagada ‚úì'};
      if(d.apr > 20)             return {cls:'over',  label:'APR alto'};
      if(d.payments?.length > 0) return {cls:'ok',   label:'Al d√≠a'};
      return                            {cls:'none',  label:'Sin abonos'};
    }

    function getCatName(id){
      return BASE_CATEGORIES.find(c => c.id===id)?.name || 'Otro';
    }

    function getSelectedDebt(){
      return debts.find(d => d.id === selectedDebtId) || null;
    }

    function buildCategorySelect(el, includeAll){
      el.innerHTML = '';
      if(includeAll){
        const opt = document.createElement('option');
        opt.value = 'all'; opt.textContent = 'Todas las categor√≠as';
        el.appendChild(opt);
      }
      BASE_CATEGORIES.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id; opt.textContent = c.name;
        el.appendChild(opt);
      });
    }

    function openModal(el){ el.classList.add('show'); el.setAttribute('aria-hidden','false'); }
    function closeModal(el){ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); }

    function money(n){
      return Number(n||0).toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0});
    }

    function clamp(n,a,b){ return Math.min(b, Math.max(a, n)); }

    function isoToday(){
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function fmtDate(iso){
      try{
        const d = new Date(iso + 'T00:00:00');
        return d.toLocaleDateString('es-US',{year:'numeric',month:'short',day:'2-digit'});
      }catch(_){ return iso; }
    }

    function debounce(fn, ms){
      let t = null;
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    }

    function shake(el){
      el.style.boxShadow = '0 0 0 3px rgba(239,68,68,.22)';
      el.animate(
        [{transform:'translateX(0)'},{transform:'translateX(-5px)'},{transform:'translateX(5px)'},{transform:'translateX(0)'}],
        {duration:200}
      );
      setTimeout(() => el.style.boxShadow = '', 400);
    }

    // Toast
    let toastTimer = null;
    function showToast(emoji, msg){
      const toast = document.getElementById('toast');
      document.getElementById('toastEmoji').textContent = emoji;
      document.getElementById('toastMsg').textContent   = msg;
      toast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove('show'), 3200);
    }

    // Confetti
    function triggerConfetti(big){
      const wrap   = document.getElementById('confettiWrap');
      const colors = ['#594AE2','#E8C239','#22C55E','#F97316','#EC4899','#7459D9'];
      const count  = big ? 60 : 30;
      wrap.innerHTML = '';
      for(let i = 0; i < count; i++){
        const el = document.createElement('div');
        el.className = 'confetti-piece';
        el.style.left     = Math.random() * 100 + 'vw';
        el.style.top      = '-10px';
        el.style.background = colors[Math.floor(Math.random() * colors.length)];
        el.style.animationDelay = (Math.random() * 0.6) + 's';
        el.style.animationDuration = (0.8 + Math.random() * 0.8) + 's';
        el.style.width  = (6 + Math.random() * 6) + 'px';
        el.style.height = (6 + Math.random() * 6) + 'px';
        el.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
        wrap.appendChild(el);
      }
      setTimeout(() => wrap.innerHTML = '', 2000);
    }

    // Mobile tabs
    function showMobileTab(tab){
      const lista   = document.getElementById('panelLista');
      const detalle = document.getElementById('panelDetalle');
      const tabL    = document.getElementById('tabLista');
      const tabD    = document.getElementById('tabDetalle');
      if(tab === 'lista'){
        lista.classList.add('tab-active');
        detalle.classList.remove('tab-active');
        tabL.classList.add('active'); tabD.classList.remove('active');
      } else {
        detalle.classList.add('tab-active');
        lista.classList.remove('tab-active');
        tabD.classList.add('active'); tabL.classList.remove('active');
      }
    }

    function rid(){ return Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2); }

    function esc(s){
      return String(s??'').replace(/[&<>"']/g, m =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
