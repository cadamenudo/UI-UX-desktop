<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cada Menudo – Bajar Deuda (Desktop)</title>

  <!-- Nunito -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --sidebar-w: 280px;
      --header-h: 64px;
      --primary:#3956E8;
      --secondary:#7459D9;
      --yellow:#E8C239;
      --gray:#64748B;
      --muted:#EEF0F6;
      --bg:#F7F8FC;
      --card:#FFFFFF;
      --text:#0F172A;
      --border:#E5E7EB;
      --shadow:0 6px 18px rgba(17,24,39,.06);

      /* inputs */
      --placeholder:#94a3b8;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      font-family:"Nunito", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
    }

    /* ===== HEADER ===== */
    header{
      position:fixed; top:0; left:0; right:0;
      height:var(--header-h);
      background:#594AE2;
      border:none;
      z-index:100;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 20px;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
      color:#fff;
    }
    header *{ color:#fff !important; }
    header .logo img{height:44px; object-fit:contain}

    .usuario-header{
      display:flex; align-items:center; gap:10px;
      font-weight:700; font-size:15px; color:#fff;
    }
    .usuario-header .avatar{
      width:38px; height:38px; border-radius:50%;
      background:#C7BEFF url('https://cadamenudo.github.io/UI-UX/assets/icons/user-placeholder.png') center/60% no-repeat;
      border:2px solid rgba(255,255,255,0.3);
    }

    /* ===== MAIN LAYOUT (sin sidebar) ===== */
    main{
      margin-top:var(--header-h);
      padding:24px;
      max-width: 1320px;
      margin-left:auto;
      margin-right:auto;
      display:block;
    }

    .card{
      background:#fff;
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:18px;
    }

    /* ===== TOP ROW: TITULO + BUSCADOR/CTA ===== */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:16px;
    }
    .title h1{
      margin:0;
      font-size:22px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .title p{
      margin:6px 0 0;
      color:var(--gray);
      font-weight:700;
      font-size:13px;
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .search{
      width:380px;
      max-width:46vw;
      display:flex;
      align-items:center;
      gap:10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      padding:10px 12px;
    }
    .search .k{ color:var(--gray); font-weight:900; font-size:12px; }
    .search input{
      width:100%;
      border:0;
      outline:none;
      font-family:"Nunito", system-ui, sans-serif;
      font-weight:700;
      font-size:14px;
      color:var(--text);
    }

    .btn{
      border:0;
      border-radius:12px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      font-family:"Nunito", system-ui, sans-serif;
      letter-spacing:.2px;
    }
    .btn.primary{
      background:#594AE2;
      color:#fff;
      box-shadow:0 10px 18px rgba(89,74,226,.22);
    }
    .btn.ghost{
      background:#fff;
      color:var(--gray);
      border:1px solid var(--border);
    }
    .btn:active{ transform:translateY(1px); }

    /* ✅ Placeholder gris suave */
    input::placeholder{ color: var(--placeholder); font-weight:700; }

    /* ===== BANNER RESUMEN (estilo cards Cada Menudo) ===== */
    .contenido-tablero{ width:100%; margin: 0 0 18px 0; }
    .header-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:18px;
      align-items: stretch;
      width: 100%;
      background: transparent;
      padding: 0;
      border: 0;
      box-shadow: none;
    }

    .resumen-unificado.card{
      width:100%;
      padding:16px 20px;
      min-height:100px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:18px;
    }

    .resumen-unificado .bloque-indicador{
      flex: 1;
      display:flex;
      align-items:center;
      gap:12px;
      background:#FFFFFF;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 16px;
      min-height:72px;
    }

    .ico{
      width:40px; height:40px;
      border-radius:12px;
      display:grid;
      place-items:center;
      font-weight:900;
      color: var(--primary);
      background: rgba(57,86,232,.10);
      border:1px solid rgba(57,86,232,.18);
      flex:0 0 40px;
    }
    .ico.yellow{
      color:#8a6a00;
      background: rgba(232,194,57,.22);
      border-color: rgba(232,194,57,.35);
    }

    .metric{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .metric .label{
      font-size:12px;
      color:var(--gray);
      font-weight:800;
      letter-spacing:.02em;
      margin-bottom:6px;
    }
    .metric .value{
      font-size:20px;
      font-weight:900;
      color:var(--text);
      letter-spacing:.2px;
    }
    .metric .sub{
      margin-top:6px;
      font-size:12px;
      color:var(--gray);
      font-weight:700;
    }

    /* ===== LAYOUT PRINCIPAL: LISTA | DETALLE ===== */
    .grid{
      display:grid;
      grid-template-columns: 440px 1fr;
      gap:20px;
      align-items:start;
    }

    .card-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .card-head h3{
      margin:0;
      font-size:16px;
      font-weight:900;
    }
    .meta{
      color:var(--gray);
      font-weight:800;
      font-size:12px;
    }

    .field label{
      display:block;
      font-size:12px;
      color:var(--gray);
      text-transform:uppercase;
      letter-spacing:.1em;
      margin: 0 0 8px 2px;
      font-weight:800;
    }
    .field select{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      font-family:"Nunito", system-ui, sans-serif;
      font-weight:700;
      color:var(--text);
    }

    .debtList{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 66vh;
      overflow:auto;
      padding-right:2px;
    }

    .debtItem{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease;
    }
    .debtItem:hover{ background: var(--muted); }
    .debtItem.active{
      background: rgba(57,86,232,.08);
      border-color: rgba(57,86,232,.20);
    }
    .dname{ font-weight:900; font-size:14px; }
    .dsub{ margin-top:4px; color:var(--gray); font-weight:700; font-size:12px; }

    .amountCol{ text-align:right; min-width:140px; }
    .amountCol .amt{ font-weight:900; font-size:14px; }
    .amountCol .mini{ margin-top:4px; color:var(--gray); font-weight:800; font-size:12px; }

    /* ===== DETALLE / PROGRESO ===== */
    .hero{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .hero h4{ margin:0; font-size:18px; font-weight:900; }
    .hero p{ margin:6px 0 0; color:var(--gray); font-weight:700; font-size:13px; }

    .progressBox{
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      background:#fff;
    }
    .progTop{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .bigPct{
      font-size:26px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .bigBal{
      text-align:right;
    }
    .bigBal .lbl{ color:var(--gray); font-weight:800; font-size:12px; text-transform:uppercase; letter-spacing:.1em; }
    .bigBal .val{ font-size:18px; font-weight:900; margin-top:6px; }

    .bar{
      width:100%;
      height:12px;
      border-radius:999px;
      background: #E9ECF6;
      overflow:hidden;
      border:1px solid var(--border);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius:999px;
      transition: width .35s ease;
    }

    .metrics{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
      margin-top:12px;
    }
    .m{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .m .k{ font-size:11px; color:var(--gray); font-weight:900; text-transform:uppercase; letter-spacing:.1em; }
    .m .v{ margin-top:8px; font-weight:900; font-size:14px; }

    .box{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      background:#fff;
    }
    .box .box-title{
      font-weight:900;
      margin:0 0 10px;
      font-size:13px;
      color:var(--text);
    }

    .history{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 340px;
      overflow:auto;
      padding-right:2px;
    }
    .tx{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
      align-items:center;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
    }
    .tx b{ font-weight:900; font-size:13px; }
    .tx small{ display:block; margin-top:4px; color:var(--gray); font-weight:700; font-size:12px; }
    .tx .amt{ font-weight:900; }

    /* ===== MODAL ===== */
    .overlay{
      position:fixed; inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:200;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(560px, 96vw);
      border-radius:18px;
      background:#fff;
      box-shadow: 0 22px 60px rgba(0,0,0,.25);
      overflow:hidden;
      border:1px solid var(--border);
    }
    .modalHd{
      padding:14px 16px;
      background: #F3F4FF;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalHd b{ font-size:14px; font-weight:900; color:var(--text); }
    .xBtn{
      width:34px; height:34px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      color:var(--gray);
    }
    .modalBd{ padding:14px 16px 16px; }
    .modalGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .modalFoot{
      padding:12px 16px 16px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }

    .field input{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-family:"Nunito", system-ui, sans-serif;
      font-weight:700;
      color:var(--text);
      outline:none;
      background:#fff;
    }

    /* Responsive */
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
      .search{ width:100%; max-width:none; }
      .metrics{ grid-template-columns: 1fr 1fr; }
      .resumen-unificado.card{ flex-direction:column; align-items:stretch; }
    }
  </style>
</head>

<body>
  <!-- HEADER (simple placeholder) -->
  <header>
    <div class="logo" aria-label="Cada Menudo">
      <!-- si tienes logo real, reemplaza el src -->
      <img src="https://cadamenudo.github.io/UI-UX/assets/icons/nueva.png" alt="Cada Menudo"/>
    </div>

    <div class="usuario-header">
      <div class="avatar" aria-hidden="true"></div>
      <div>Mi perfil</div>
    </div>
  </header>

  <main>
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="title">
        <h1>Bajar deuda</h1>
        <p>Transparencia total: total deuda, cuánto pagaste y cuánto falta. Sin borrar historial.</p>
      </div>

      <div class="actions">
        <div class="search" role="search">
          <span class="k">⌕</span>
          <input id="q" type="text" placeholder="Buscar deuda (ej. Visa, Auto, Universidad)…" />
          <span class="k">⌘K</span>
        </div>
        <button class="btn primary" id="btnNewDebt" type="button">+ Nueva deuda</button>
      </div>
    </div>

    <!-- ✅ BANNER RESUMEN -->
    <section class="contenido-tablero" aria-label="Resumen de deuda">
      <div class="header-grid">
        <div class="resumen-unificado card">
          <div class="bloque-indicador">
            <div class="ico">Σ</div>
            <div class="metric">
              <div class="label">Total deuda</div>
              <div class="value" id="sumTotalDebt">$0</div>
              <div class="sub">Monto original acumulado</div>
            </div>
          </div>

          <div class="bloque-indicador">
            <div class="ico">✓</div>
            <div class="metric">
              <div class="label">Monto pagado</div>
              <div class="value" id="sumTotalPaid">$0</div>
              <div class="sub">Abonos acumulados</div>
            </div>
          </div>

          <div class="bloque-indicador">
            <div class="ico yellow">↘</div>
            <div class="metric">
              <div class="label">Falta por pagar</div>
              <div class="value" id="sumTotalRemaining">$0</div>
              <div class="sub">Saldo real acumulado</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- GRID -->
    <section class="grid">
      <!-- LISTA -->
      <div class="card">
        <div class="card-head">
          <h3>Deudas</h3>
          <div class="meta"><span id="countDebts">0</span> activas</div>
        </div>

        <div class="field">
          <label for="filterCategory">Categoría</label>
          <select id="filterCategory"></select>
        </div>

        <div class="debtList" id="debtList"></div>
      </div>

      <!-- DETALLE -->
      <div class="card">
        <div class="hero">
          <div>
            <h4 id="dTitle">Selecciona una deuda</h4>
            <p id="dSubtitle">Verás monto original, total abonado, saldo real y % pagado.</p>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="btn ghost" id="btnAddPayment" type="button" disabled>+ Abono</button>
            <button class="btn ghost" id="btnEditDebt" type="button" disabled>Editar</button>
          </div>
        </div>

        <div class="progressBox">
          <div class="progTop">
            <div>
              <div class="meta" style="text-transform:uppercase;letter-spacing:.1em">Porcentaje pagado</div>
              <div class="bigPct" id="dPct">—</div>
            </div>
            <div class="bigBal">
              <div class="lbl">Saldo actual real</div>
              <div class="val" id="dBalance">—</div>
            </div>
          </div>

          <div class="bar"><div id="barFill"></div></div>

          <div class="metrics">
            <div class="m">
              <div class="k">Monto original</div>
              <div class="v" id="dOriginal">—</div>
            </div>
            <div class="m">
              <div class="k">Total abonado</div>
              <div class="v" id="dPaid">—</div>
            </div>
            <div class="m">
              <div class="k">% pagado</div>
              <div class="v" id="dPctSmall">—</div>
            </div>
            <div class="m">
              <div class="k">Categoría</div>
              <div class="v" id="dCat">—</div>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="box-title">Historial de abonos</div>
          <div class="history" id="history"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL: ABONO -->
  <div class="overlay" id="overlayPay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="payTitle">
      <div class="modalHd">
        <b id="payTitle">Registrar abono</b>
        <button class="xBtn" id="closePay" type="button" aria-label="Cerrar">✕</button>
      </div>
      <div class="modalBd">
        <div class="modalGrid">
          <div class="field">
            <label for="payDate">Fecha</label>
            <input id="payDate" type="date"/>
          </div>
          <div class="field">
            <label for="payAmount">Monto abonado</label>
            <input id="payAmount" type="number" min="0" step="0.01" placeholder="Ej. 125.00"/>
          </div>
          <div class="field" style="grid-column:1 / -1;">
            <label for="payNote">Nota (opcional)</label>
            <input id="payNote" type="text" placeholder="Ej. Pago mínimo, pago extra…"/>
          </div>
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn ghost" id="cancelPay" type="button">Cancelar</button>
        <button class="btn primary" id="savePay" type="button">Guardar abono</button>
      </div>
    </div>
  </div>

  <!-- MODAL: NUEVA DEUDA -->
  <div class="overlay" id="overlayDebt" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="debtTitle">
      <div class="modalHd">
        <b id="debtTitle">Nueva deuda</b>
        <button class="xBtn" id="closeDebt" type="button" aria-label="Cerrar">✕</button>
      </div>
      <div class="modalBd">
        <div class="modalGrid">
          <div class="field">
            <label for="newName">Nombre</label>
            <input id="newName" type="text" placeholder="Ej. Visa, Auto, Préstamo…"/>
          </div>
          <div class="field">
            <label for="newCategory">Categoría</label>
            <select id="newCategory"></select>
          </div>
          <div class="field">
            <label for="newOriginal">Monto original</label>
            <input id="newOriginal" type="number" min="0" step="0.01" placeholder="Ej. 5000"/>
          </div>
          <div class="field">
            <label for="newApr">APR / interés (opcional)</label>
            <input id="newApr" type="number" min="0" step="0.01" placeholder="Ej. 24.99"/>
          </div>
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn ghost" id="cancelDebt" type="button">Cancelar</button>
        <button class="btn primary" id="saveDebt" type="button">Crear deuda</button>
      </div>
    </div>
  </div>

  <script>
    const BASE_CATEGORIES = [
      {id:'all', name:'Todas'},
      {id:'tarjetas',name:'Tarjetas de Crédito, tiendas, gasolinera, etc.'},
      {id:'linea_personal',name:'Línea crédito personal'},
      {id:'linea_propiedad',name:'Línea crédito de la propiedad'},
      {id:'casa',name:'Casa'},
      {id:'otras_propiedades',name:'Otras propiedad (barco, casa de playa, etc.)'},
      {id:'auto',name:'Auto'},
      {id:'educacion',name:'Educación'},
      {id:'muebles',name:'Préstamos para Muebles y Enseres'},
      {id:'mejoras',name:'Mejoras al hogar'},
      {id:'seguro_vida',name:'Préstamo de seguro de vida'},
      {id:'margen_broker',name:'Préstamos al Margen con casa de corretaje'},
      // agrega el resto…
    ];

    // Demo
    let debts = [
      { id: rid(), name:'Visa – Banco', categoryId:'tarjetas', original:8200, apr:24.99,
        payments:[{date:'2026-01-10',amount:250,note:'Pago mínimo'},{date:'2026-02-05',amount:400,note:'Pago extra'}]},
      { id: rid(), name:'Préstamo Auto', categoryId:'auto', original:14500, apr:7.5,
        payments:[{date:'2026-01-15',amount:375,note:'Pago mensual'},{date:'2026-02-15',amount:375,note:'Pago mensual'}]},
      { id: rid(), name:'Universidad', categoryId:'educacion', original:5200, apr:0,
        payments:[{date:'2026-02-01',amount:200,note:'Abono'}]},
    ];
    let selectedDebtId = null;

    // UI
    const debtListEl = document.getElementById('debtList');
    const countDebtsEl = document.getElementById('countDebts');
    const filterCategoryEl = document.getElementById('filterCategory');
    const qEl = document.getElementById('q');

    const dTitle = document.getElementById('dTitle');
    const dSubtitle = document.getElementById('dSubtitle');
    const dPct = document.getElementById('dPct');
    const dPctSmall = document.getElementById('dPctSmall');
    const dBalance = document.getElementById('dBalance');
    const dOriginal = document.getElementById('dOriginal');
    const dPaid = document.getElementById('dPaid');
    const dCat = document.getElementById('dCat');
    const barFill = document.getElementById('barFill');
    const historyEl = document.getElementById('history');
    const btnAddPayment = document.getElementById('btnAddPayment');
    const btnEditDebt = document.getElementById('btnEditDebt');

    // Summary banner
    const sumTotalDebt = document.getElementById('sumTotalDebt');
    const sumTotalPaid = document.getElementById('sumTotalPaid');
    const sumTotalRemaining = document.getElementById('sumTotalRemaining');

    // Modals
    const overlayPay = document.getElementById('overlayPay');
    const overlayDebt = document.getElementById('overlayDebt');

    const btnNewDebt = document.getElementById('btnNewDebt');
    const closePay = document.getElementById('closePay');
    const cancelPay = document.getElementById('cancelPay');
    const savePay = document.getElementById('savePay');
    const payDate = document.getElementById('payDate');
    const payAmount = document.getElementById('payAmount');
    const payNote = document.getElementById('payNote');

    const closeDebt = document.getElementById('closeDebt');
    const cancelDebt = document.getElementById('cancelDebt');
    const saveDebt = document.getElementById('saveDebt');
    const newName = document.getElementById('newName');
    const newCategory = document.getElementById('newCategory');
    const newOriginal = document.getElementById('newOriginal');
    const newApr = document.getElementById('newApr');

    hydrateCategorySelect(filterCategoryEl, true);
    hydrateCategorySelect(newCategory, false);
    payDate.value = isoToday();
    render();

    // Events
    filterCategoryEl.addEventListener('change', render);
    qEl.addEventListener('input', debounce(render, 120));

    btnNewDebt.addEventListener('click', () => {
      openModal(overlayDebt);
      newName.value = '';
      newOriginal.value = '';
      newApr.value = '';
      newCategory.value = BASE_CATEGORIES.find(c => c.id !== 'all')?.id || 'tarjetas';
      setTimeout(()=>newName.focus(),0);
    });

    btnAddPayment.addEventListener('click', () => {
      if(!selectedDebtId) return;
      openModal(overlayPay);
      payDate.value = isoToday();
      payAmount.value = '';
      payNote.value = '';
      setTimeout(()=>payAmount.focus(),0);
    });

    closePay.addEventListener('click', ()=>closeModal(overlayPay));
    cancelPay.addEventListener('click', ()=>closeModal(overlayPay));
    closeDebt.addEventListener('click', ()=>closeModal(overlayDebt));
    cancelDebt.addEventListener('click', ()=>closeModal(overlayDebt));

    savePay.addEventListener('click', () => {
      const d = getSelectedDebt();
      if(!d) return;

      const amt = Number(payAmount.value || 0);
      const dt = payDate.value || isoToday();
      const note = (payNote.value || '').trim();

      if(amt <= 0){ shake(payAmount); payAmount.focus(); return; }

      d.payments.push({date:dt, amount:amt, note});
      closeModal(overlayPay);
      render();
    });

    saveDebt.addEventListener('click', () => {
      const name = (newName.value || '').trim();
      const cat = newCategory.value;
      const orig = Number(newOriginal.value || 0);
      const apr = Number(newApr.value || 0);

      if(!name){ shake(newName); newName.focus(); return; }
      if(orig <= 0){ shake(newOriginal); newOriginal.focus(); return; }

      debts.unshift({ id: rid(), name, categoryId:cat, original:orig, apr, payments:[] });
      selectedDebtId = debts[0].id;
      closeModal(overlayDebt);
      render();
    });

    document.addEventListener('keydown', (e) => {
      const k = e.key.toLowerCase();
      if((e.metaKey || e.ctrlKey) && k === 'k'){ e.preventDefault(); qEl.focus(); }
      if(k === 'escape'){ closeModal(overlayPay); closeModal(overlayDebt); }
    });

    overlayPay.addEventListener('click', (e)=>{ if(e.target===overlayPay) closeModal(overlayPay); });
    overlayDebt.addEventListener('click', (e)=>{ if(e.target===overlayDebt) closeModal(overlayDebt); });

    // Render
    function render(){
      renderSummary();
      renderList();
      countDebtsEl.textContent = debts.length;

      const selected = getSelectedDebt();
      if(selected) renderDetail(selected);
      else renderEmptyDetail();
    }

    function renderSummary(){
      const totals = debts.reduce((acc,d)=>{
        const paid = (d.payments||[]).reduce((s,p)=> s + Number(p.amount||0), 0);
        acc.original += Number(d.original||0);
        acc.paid += paid;
        return acc;
      }, {original:0, paid:0});

      const remaining = Math.max(0, totals.original - totals.paid);

      sumTotalDebt.textContent = money(totals.original);
      sumTotalPaid.textContent = money(totals.paid);
      sumTotalRemaining.textContent = money(remaining);
    }

    function renderList(){
      const filtered = applyFilters(debts);
      debtListEl.innerHTML = '';

      if(filtered.length === 0){
        debtListEl.innerHTML = `
          <div class="tx">
            <div>
              <b>No hay deudas que coincidan</b>
              <small>Ajusta filtros o crea una nueva deuda.</small>
            </div>
          </div>`;
        return;
      }

      filtered.forEach(d=>{
        const stats = compute(d);
        const catName = getCatName(d.categoryId);
        const active = d.id === selectedDebtId;

        const row = document.createElement('div');
        row.className = 'debtItem' + (active ? ' active' : '');
        row.innerHTML = `
          <div>
            <div class="dname">${esc(d.name)}</div>
            <div class="dsub">${esc(catName)} · ${d.apr ? (d.apr.toFixed(2)+'% APR') : 'sin APR'}</div>
          </div>
          <div class="amountCol">
            <div class="amt">${money(stats.balance)}</div>
            <div class="mini">${stats.pct.toFixed(0)}% pagado</div>
          </div>
        `;
        row.addEventListener('click', ()=>{
          selectedDebtId = d.id;
          renderList();
          renderDetail(d);
        });

        debtListEl.appendChild(row);
      });

      if(!selectedDebtId && filtered[0]){
        selectedDebtId = filtered[0].id;
        renderList();
        renderDetail(getSelectedDebt());
      }
    }

    function renderDetail(d){
      btnAddPayment.disabled = false;
      btnEditDebt.disabled = false;

      const stats = compute(d);
      const catName = getCatName(d.categoryId);

      dTitle.textContent = d.name;
      dSubtitle.textContent = `${catName} · Historial intacto`;

      dPct.textContent = `${stats.pct.toFixed(0)}%`;
      dPctSmall.textContent = `${stats.pct.toFixed(0)}%`;
      dBalance.textContent = money(stats.balance);
      dOriginal.textContent = money(d.original);
      dPaid.textContent = money(stats.paid);
      dCat.textContent = catName;
      barFill.style.width = clamp(stats.pct, 0, 100) + '%';

      historyEl.innerHTML = '';
      const sorted = [...(d.payments||[])].sort((a,b)=> (a.date < b.date ? 1 : -1));
      if(sorted.length === 0){
        historyEl.innerHTML = `
          <div class="tx">
            <div>
              <b>Sin abonos aún</b>
              <small>Registra un abono para ver progreso tangible.</small>
            </div>
          </div>`;
        return;
      }

      sorted.forEach(p=>{
        const item = document.createElement('div');
        item.className = 'tx';
        item.innerHTML = `
          <div>
            <b>${fmtDate(p.date)}</b>
            <small>${esc(p.note || 'Abono')}</small>
          </div>
          <div class="amt">${money(p.amount)}</div>
        `;
        historyEl.appendChild(item);
      });
    }

    function renderEmptyDetail(){
      btnAddPayment.disabled = true;
      btnEditDebt.disabled = true;

      dTitle.textContent = 'Selecciona una deuda';
      dSubtitle.textContent = 'Verás monto original, total abonado, saldo real y % pagado.';
      dPct.textContent = '—';
      dPctSmall.textContent = '—';
      dBalance.textContent = '—';
      dOriginal.textContent = '—';
      dPaid.textContent = '—';
      dCat.textContent = '—';
      barFill.style.width = '0%';

      historyEl.innerHTML = `
        <div class="tx">
          <div>
            <b>Historial</b>
            <small>Selecciona una deuda para ver sus abonos.</small>
          </div>
        </div>`;
    }

    // Utils
    function applyFilters(list){
      const cat = filterCategoryEl.value || 'all';
      const q = (qEl.value || '').trim().toLowerCase();

      return list.filter(d=>{
        const okCat = (cat === 'all') ? true : d.categoryId === cat;
        const okQ = !q ? true : (d.name.toLowerCase().includes(q) || getCatName(d.categoryId).toLowerCase().includes(q));
        return okCat && okQ;
      });
    }

    function compute(d){
      const paid = (d.payments||[]).reduce((s,p)=> s + Number(p.amount||0), 0);
      const balance = Math.max(0, Number(d.original||0) - paid);
      const pct = (Number(d.original||0) > 0) ? (paid / d.original * 100) : 0;
      return {paid, balance, pct};
    }

    function hydrateCategorySelect(selectEl, includeAll){
      selectEl.innerHTML = '';
      BASE_CATEGORIES.forEach(c=>{
        if(!includeAll && c.id==='all') return;
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        selectEl.appendChild(opt);
      });
      if(includeAll) selectEl.value = 'all';
    }

    function getCatName(id){
      return BASE_CATEGORIES.find(c=>c.id===id)?.name || 'Categoría';
    }

    function getSelectedDebt(){
      return debts.find(d=>d.id===selectedDebtId) || null;
    }

    function openModal(el){ el.classList.add('show'); el.setAttribute('aria-hidden','false'); }
    function closeModal(el){ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); }

    function money(n){
      const v = Number(n||0);
      return v.toLocaleString('en-US', {style:'currency', currency:'USD', maximumFractionDigits:0});
    }
    function clamp(n,a,b){ return Math.min(b, Math.max(a, n)); }

    function isoToday(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function fmtDate(iso){
      try{
        const d = new Date(iso + 'T00:00:00');
        return d.toLocaleDateString('es-US', {year:'numeric', month:'short', day:'2-digit'});
      }catch(_){ return iso; }
    }

    function debounce(fn, ms){
      let t=null;
      return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
    }

    function shake(el){
      const old = el.style.boxShadow;
      el.style.boxShadow = '0 0 0 3px rgba(239,68,68,.22)';
      el.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],
                 {duration:220, iterations:1});
      setTimeout(()=> el.style.boxShadow = old, 420);
    }

    function rid(){ return Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2); }
    function esc(s){
      return String(s ?? '').replace(/[&<>"']/g, (m)=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }
  </script>
</body>
</html>
